<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ÊãØÊïëZack - MTÂ§ßÂÜíÈô©</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #222;
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            box-sizing: border-box;
            /* Èò≤Ê≠¢È°µÈù¢ÊªöÂä® */
            overflow-x: hidden;
            position: relative;
        }
        
        /* Â∞èÂ±èÂπïËÆæÂ§á‰ºòÂåñ */
        @media (max-width: 850px) {
            body {
                padding: 10px;
                /* ÂÖÅËÆ∏ÂûÇÁõ¥ÊªöÂä®‰ª•ÊòæÁ§∫ÊâÄÊúâÂÜÖÂÆπÔºå‰ΩÜÈòªÊ≠¢Ê∞¥Âπ≥ÊªöÂä® */
                overflow-x: hidden;
                overflow-y: auto;
            }
            
            #game-container {
                width: 95%;
                max-width: 800px;
                height: 300px; /* Âú®Â∞èÂ±èÂπï‰∏äÂáèÂ∞èÊ∏∏ÊàèÂå∫ÂüüÈ´òÂ∫¶ */
            }
            
            .level-info {
                font-size: 20px;
                margin: 8px 0;
            }
            
            .controls {
                margin: 15px 0;
            }
            
            button {
                padding: 8px 16px;
                font-size: 14px;
                margin: 5px;
            }
            
            .location-info {
                font-size: 16px;
                padding: 6px 12px;
                margin-bottom: 10px;
            }
        }
        
        /* Ë∂ÖÂ∞èÂ±èÂπïËÆæÂ§á‰ºòÂåñ */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            #game-container {
                width: 98%;
                height: 250px;
            }
            
            .level-info {
                font-size: 18px;
                margin: 5px 0;
            }
            
            button {
                padding: 6px 12px;
                font-size: 12px;
                margin: 3px;
            }
            
            .location-info {
                font-size: 14px;
                padding: 4px 8px;
            }
        }
        #game-container {
            position: relative;
            width: 800px;
            height: 500px;
            margin: 0 auto;
            background-color: #333;
            border: 3px solid #555;
            overflow: hidden;
        }
        
        #game-container.hell-mode {
            background: linear-gradient(45deg, #1a0000, #330000, #1a0000, #330000);
            background-size: 40px 40px;
            animation: hellBackground 3s linear infinite;
            border: 3px solid #ff0000;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5), inset 0 0 20px rgba(255, 0, 0, 0.2);
        }
        
        @keyframes hellBackground {
            0% { background-position: 0px 0px; }
            100% { background-position: 40px 40px; }
        }
        #player {
            position: absolute;
            width: 40px;
            height: 50px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #player::before {
            content: 'üßô‚Äç‚ôÇÔ∏è';
            font-size: 35px;
            animation: fly 1s ease-in-out infinite alternate;
        }
        
        @keyframes fly {
            0% { transform: translateY(0px) rotate(-2deg); }
            100% { transform: translateY(-8px) rotate(2deg); }
        }
        #door {
            position: absolute;
            width: 60px;
            height: 100px;
            background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 50%, #000 100%);
            border: 5px solid #8B4513;
            border-radius: 10px 10px 0 0;
            right: 20px;
            bottom: 0;
            z-index: 5;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }
        
        #door::before {
            content: 'üö™';
            position: absolute;
            font-size: 40px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.8;
        }
        
        #door::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: #FFD700;
            border-radius: 50%;
            right: 8px;
            top: 45%;
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        .trap {
            position: absolute;
            background-color: #8B4513;
            border: 2px solid #654321;
            z-index: 2;
        }
        .level-info {
            font-size: 24px;
            margin: 10px 0;
        }
        #progress-info {
            font-size: 18px;
            color: #FFD700;
            font-weight: normal;
        }

        #loop-info {
            color: #e74c3c;
            font-size: 18px;
            margin-left: 15px;
            font-weight: bold;
        }
        
        .location-info {
            text-align: center;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
            color: #e74c3c;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 2px solid #e74c3c;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        
        /* ÂÖ≥Âç°ÈÄâÊã©Âô®Ê†∑Âºè */
        #level-select {
            background-color: rgba(0,0,0,0.9);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        #level-select.hidden {
            display: none !important;
        }
        
        #level-buttons {
            display: grid;
            grid-template-columns: repeat(10, 60px);
            gap: 10px;
            margin: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .level-btn {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
        }
        
        .level-btn.unlocked {
            background-color: #4CAF50;
            border: 2px solid #45a049;
        }
        
        .level-btn.current {
            background-color: #FFD700;
            color: #333;
            border: 2px solid #FFA500;
        }
        
        .level-btn.locked {
            background-color: #666;
            color: #999;
            cursor: not-allowed;
            border: 2px solid #555;
        }
        
        #close-select-btn {
            background-color: #f44336;
            margin-top: 20px;
        }
        
        #close-select-btn:hover {
            background-color: #da190b;
        }
        
        #reset-progress-btn {
            background-color: #ff9800;
        }
        
        #reset-progress-btn:hover {
            background-color: #e68900;
        }
        
        /* Èü≥‰πêÊéßÂà∂ÊåâÈíÆÊ†∑Âºè */
        #music-toggle-btn {
            background-color: #9C27B0;
        }
        
        #music-toggle-btn:hover {
            background-color: #7B1FA2;
        }
        
        /* ÊéíË°åÊ¶úÊåâÈíÆÊ†∑Âºè */
        #leaderboard-btn {
            background-color: #FF5722;
        }
        
        #leaderboard-btn:hover {
            background-color: #E64A19;
        }
        
        /* ÂìçÂ∫îÂºèËÆæËÆ° - Â∞èÂ±èÂπïÈÄÇÈÖç */
        @media screen and (max-width: 850px) {
            body {
                padding: 10px;
            }
            
            #game-container {
                width: 95vw;
                max-width: 800px;
                height: 60vh;
                min-height: 400px;
                max-height: 500px;
            }
            
            .level-info {
                font-size: 18px;
                margin: 5px 0;
            }
            
            #progress-info, #loop-info {
                font-size: 14px;
            }
            
            .location-info {
                font-size: 16px;
                padding: 6px 12px;
                margin-bottom: 10px;
            }
            
            .controls {
                margin: 15px 0;
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }
            
            button {
                padding: 8px 12px;
                font-size: 14px;
                margin: 2px;
                flex: 0 1 auto;
                min-width: 120px;
            }
            
            h1 {
                font-size: 24px;
                margin: 10px 0;
            }
        }
        
        @media screen and (max-width: 600px) {
            body {
                padding: 5px;
            }
            
            #game-container {
                width: 98vw;
                height: 50vh;
                min-height: 350px;
            }
            
            .level-info {
                font-size: 16px;
                line-height: 1.3;
            }
            
            #progress-info, #loop-info {
                font-size: 12px;
                display: block;
                margin: 2px 0;
            }
            
            .location-info {
                font-size: 14px;
                padding: 4px 8px;
            }
            
            .controls {
                margin: 10px 0;
                gap: 5px;
            }
            
            button {
                padding: 6px 8px;
                font-size: 12px;
                min-width: 100px;
                flex: 1 1 calc(50% - 5px);
                max-width: 150px;
            }
            
            h1 {
                font-size: 20px;
                margin: 5px 0;
            }
            
            /* ÂÖ≥Âç°ÈÄâÊã©Âô®Âú®Â∞èÂ±èÂπï‰∏äÁöÑ‰ºòÂåñ */
            #level-buttons {
                grid-template-columns: repeat(5, 50px);
                gap: 8px;
            }
            
            .level-btn {
                width: 50px;
                height: 50px;
                font-size: 14px;
            }
        }
        
        @media screen and (max-width: 400px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 90%;
                max-width: 200px;
                margin: 3px 0;
            }
            
            #level-buttons {
                grid-template-columns: repeat(4, 45px);
                gap: 6px;
            }
            
            .level-btn {
                width: 45px;
                height: 45px;
                font-size: 12px;
            }
        }
        
        /* ÁßªÂä®Á´ØËôöÊãüÊñπÂêëÈîÆ - Âè™Âú®Ëß¶Êë∏ËÆæÂ§á‰∏äÊòæÁ§∫ */
        .mobile-controls {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            opacity: 0.7;
        }
        
        .dpad {
            position: relative;
            width: 80px;
            height: 80px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        /* Ëß¶Êë∏Êìç‰ΩúÊèêÁ§∫ */
        .touch-hint {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 16px;
            text-align: center;
            z-index: 1001;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .touch-hint.show {
            opacity: 1;
        }
        
        .dpad-btn {
            position: absolute;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid #333;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            transition: all 0.1s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .dpad-btn:active {
            background: rgba(255, 255, 255, 1);
            transform: scale(0.95);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .dpad-up {
            top: 3px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .dpad-down {
            bottom: 3px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .dpad-left {
            left: 3px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .dpad-right {
            right: 3px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        /* Âè™Âú®Ëß¶Êë∏ËÆæÂ§á‰∏äÊòæÁ§∫ËôöÊãüÊåâÈîÆ */
        @media (hover: none) and (pointer: coarse) {
            .mobile-controls {
                display: block;
            }
        }
        
        /* Á°Æ‰øùÂú®Â∞èÂ±èÂπïËß¶Êë∏ËÆæÂ§á‰∏äËôöÊãüÊåâÈîÆ‰∏ç‰ºöÈÅÆÊå°Ê∏∏ÊàèÂÜÖÂÆπ */
        @media (hover: none) and (pointer: coarse) and (max-height: 600px) {
            body {
                padding-bottom: 160px;
            }
            
            .mobile-controls {
                bottom: 10px;
            }
            
            .dpad {
                width: 100px;
                height: 100px;
            }
            
            .dpad-btn {
                width: 30px;
                height: 30px;
                font-size: 16px;
            }
        }
        
        /* Ê®™Â±èÊ®°Âºè‰∏ãÁöÑËôöÊãüÊåâÈîÆË∞ÉÊï¥ */
        @media (hover: none) and (pointer: coarse) and (orientation: landscape) {
            .mobile-controls {
                bottom: 10px;
                left: 20px;
                transform: none;
            }
            
            .dpad {
                width: 90px;
                height: 90px;
            }
            
            .dpad-btn {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }
        }
        

        

        #message {
            font-size: 24px;
            height: 30px;
            margin: 10px 0;
            color: #FFD700;
        }
        .hidden {
            display: none;
        }

        /* ÂØπËØùÊ°ÜÊ†∑Âºè */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .dialog-box {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
            position: relative;
            border: 3px solid #e74c3c;
        }

        .dialog-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 20px;
        }

        .dialog-content {
            font-size: 1.1em;
            line-height: 1.6;
            color: #ecf0f1;
            margin-bottom: 25px;
            text-align: left;
            white-space: pre-line;
        }

        .dialog-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .dialog-btn:hover {
            background: linear-gradient(45deg, #c0392b, #e74c3c);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }

        /* ZackÊãØÊïëÊàêÂäüÂØπËØùÊ°ÜÊ†∑Âºè */
        .zack-success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.95) 0%, rgba(44, 62, 80, 0.95) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: successFade 0.8s ease-in;
            overflow-y: auto;
            padding: 20px 0;
        }

        @keyframes successFade {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .zack-success-box {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
            text-align: center;
            position: relative;
            border: 4px solid #FFD700;
            animation: boxBounce 0.6s ease-out 0.2s both;
        }

        @keyframes boxBounce {
            0% { transform: translateY(-50px); opacity: 0; }
            60% { transform: translateY(10px); opacity: 1; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .zack-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            border: 4px solid #FFD700;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            animation: avatarGlow 2s ease-in-out infinite alternate;
            background-image: url('images/zack.jpeg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .zack-avatar.fallback {
            background-image: none;
        }

        @keyframes avatarGlow {
            0% { box-shadow: 0 8px 20px rgba(0,0,0,0.3), 0 0 0 0 rgba(255, 215, 0, 0.7); }
            100% { box-shadow: 0 8px 20px rgba(0,0,0,0.3), 0 0 0 20px rgba(255, 215, 0, 0); }
        }

        .zack-success-title {
            font-size: 2.2em;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .zack-success-content {
            font-size: 1.2em;
            line-height: 1.6;
            color: #ecf0f1;
            margin-bottom: 30px;
            text-align: left;
        }

        .zack-success-btn {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #1a1a2e;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .zack-success-btn:hover {
            background: linear-gradient(45deg, #FFA500, #FFD700);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
        }

        /* ÂêçÂ≠óËæìÂÖ•Ê°ÜÊ†∑Âºè */
        .name-input-container {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: rgba(52, 73, 94, 0.3);
            border-radius: 10px;
            border: 2px solid #FFD700;
        }

        .name-input-container label {
            display: block;
            color: #FFD700;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        #player-name {
            width: 100%;
            max-width: 300px;
            padding: 12px 16px;
            font-size: 1.1em;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.95);
            color: #2c3e50;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        #player-name:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            transform: scale(1.02);
        }

        /* ÊéíË°åÊ¶úÂºπÁ™óÊ†∑Âºè */
        .leaderboard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-in;
        }

        .leaderboard-box {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
            position: relative;
            border: 3px solid #FF5722;
        }

        .leaderboard-title {
            font-size: 1.8em;
            font-weight: bold;
            color: #FF5722;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .leaderboard-list {
            text-align: left;
            margin-bottom: 20px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            margin: 8px 0;
            background: rgba(52, 73, 94, 0.3);
            border-radius: 8px;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }

        .leaderboard-item:hover {
            background: rgba(52, 73, 94, 0.5);
            transform: translateX(5px);
        }

        .leaderboard-item.rank-1 {
            border-left-color: #FFD700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
        }

        .leaderboard-item.rank-2 {
            border-left-color: #C0C0C0;
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.1), rgba(192, 192, 192, 0.05));
        }

        .leaderboard-item.rank-3 {
            border-left-color: #CD7F32;
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.1), rgba(205, 127, 50, 0.05));
        }

        .leaderboard-rank {
            font-size: 1.2em;
            font-weight: bold;
            color: #ecf0f1;
            min-width: 30px;
        }

        .leaderboard-rank.rank-1 { color: #FFD700; }
        .leaderboard-rank.rank-2 { color: #C0C0C0; }
        .leaderboard-rank.rank-3 { color: #CD7F32; }

        .leaderboard-name {
            flex: 1;
            font-size: 1.1em;
            color: #ecf0f1;
            margin: 0 15px;
            font-weight: 500;
        }

        .leaderboard-deaths {
            font-size: 1em;
            color: #e74c3c;
            font-weight: bold;
            background: rgba(231, 76, 60, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .leaderboard-empty {
            text-align: center;
            color: #95a5a6;
            font-style: italic;
            padding: 40px 20px;
            font-size: 1.1em;
        }

        .leaderboard-close-btn {
            background: linear-gradient(45deg, #FF5722, #E64A19);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .leaderboard-close-btn:hover {
            background: linear-gradient(45deg, #E64A19, #FF5722);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 87, 34, 0.4);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #player-name::placeholder {
            color: #7f8c8d;
            font-style: italic;
        }

        /* Â∞èÂ±èÂπïËÆæÂ§á‰∏äÁöÑCEOÂØπËØùÊ°Ü‰ºòÂåñ */
        @media (max-width: 850px) {
            .zack-success-overlay {
                align-items: flex-start;
                padding: 10px;
            }
            
            .zack-success-box {
                padding: 20px;
                max-width: 95%;
                width: 95%;
                max-height: none;
                overflow-y: visible;
                margin: 10px auto;
                position: relative;
            }
            
            .zack-avatar {
                width: 80px;
                height: 80px;
                font-size: 40px;
                margin: 0 auto 15px;
            }
            
            .zack-success-title {
                font-size: 1.8em;
                margin-bottom: 15px;
            }
            
            .zack-success-content {
                font-size: 1em;
                line-height: 1.4;
                margin-bottom: 20px;
            }
            
            .name-input-container {
                margin: 15px 0;
                padding: 15px;
            }
            
            .name-input-container label {
                font-size: 1em;
                margin-bottom: 8px;
            }
            
            #player-name {
                max-width: 250px;
                padding: 10px 12px;
                font-size: 1em;
            }
            
            .zack-success-btn {
                padding: 12px 30px;
                font-size: 1.1em;
                margin-top: 10px;
                width: 100%;
                max-width: 280px;
            }
        }

        /* Ë∂ÖÂ∞èÂ±èÂπïËÆæÂ§á‰ºòÂåñ */
        @media (max-width: 480px) {
            .zack-success-overlay {
                align-items: flex-start;
                padding: 5px;
            }
            
            .zack-success-box {
                padding: 15px;
                max-width: 98%;
                width: 98%;
                margin: 5px auto;
            }
            
            .zack-avatar {
                width: 60px;
                height: 60px;
                font-size: 30px;
                margin: 0 auto 10px;
            }
            
            .zack-success-title {
                font-size: 1.5em;
                margin-bottom: 10px;
            }
            
            .zack-success-content {
                font-size: 0.9em;
                line-height: 1.3;
                margin-bottom: 15px;
            }
            
            .name-input-container {
                margin: 10px 0;
                padding: 10px;
            }
            
            .name-input-container label {
                font-size: 0.9em;
                margin-bottom: 6px;
            }
            
            #player-name {
                max-width: 200px;
                padding: 8px 10px;
                font-size: 0.9em;
            }
            
            .zack-success-btn {
                padding: 10px 20px;
                font-size: 1em;
                margin-top: 8px;
                width: 100%;
                max-width: 250px;
            }
        }

        /* CEOÂ∞±ËÅå‰ª™ÂºèÂä®Áîª */
        .ceo-ceremony-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            animation: ceremonyFadeIn 1s ease-in;
        }

        @keyframes ceremonyFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .mt-logo {
            font-size: 8em;
            font-weight: bold;
            background: linear-gradient(45deg, #FFD700, #FFA500, #FF6B35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
            animation: logoGlow 2s ease-in-out infinite alternate;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        @keyframes logoGlow {
            0% { 
                transform: scale(1);
                filter: brightness(1);
            }
            100% { 
                transform: scale(1.05);
                filter: brightness(1.2);
            }
        }

        .ceo-title {
            font-size: 3em;
            color: #FFD700;
            margin-bottom: 20px;
            animation: titleSlideIn 1.5s ease-out 0.5s both;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        @keyframes titleSlideIn {
            from { 
                opacity: 0;
                transform: translateY(50px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ceo-subtitle {
            font-size: 1.5em;
            color: #ecf0f1;
            margin-bottom: 40px;
            animation: subtitleFadeIn 1.5s ease-out 1s both;
            text-align: center;
            max-width: 600px;
        }

        @keyframes subtitleFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .ceo-welcome {
            font-size: 1.3em;
            color: #e74c3c;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 10px;
            border: 2px solid #e74c3c;
            animation: welcomeFadeIn 1.5s ease-out 1.5s both;
            text-align: center;
            max-width: 700px;
        }

        @keyframes welcomeFadeIn {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fireworks {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .firework {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            animation: fireworkExplode 2s ease-out infinite;
        }

        @keyframes fireworkExplode {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            50% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confettiFall 3s linear infinite;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .mt-values {
            display: flex;
            gap: 40px;
            margin-top: 30px;
            animation: valuesSlideUp 2s ease-out 1.5s both;
        }

        @keyframes valuesSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .value-item {
            text-align: center;
            color: #bdc3c7;
            font-size: 1.1em;
            max-width: 200px;
        }

        .value-icon {
            font-size: 2em;
            margin-bottom: 10px;
            display: block;
        }

        .value-desc {
            font-size: 0.9em;
            color: #95a5a6;
            margin-top: 5px;
            line-height: 1.3;
        }

        .continue-btn {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #1a1a2e;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            margin-top: 40px;
            animation: btnAppear 2s ease-out 2s both;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        @keyframes btnAppear {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .continue-btn:hover {
            background: linear-gradient(45deg, #FFA500, #FFD700);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
        }
        .spike {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 30px solid #696969;
            bottom: 0;
        }
        .moving-trap {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('images/traps/invisible.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 2;
            opacity: 0.8;
            animation: movingTrapFloat 2s ease-in-out infinite alternate;
        }
        
        @keyframes movingTrapFloat {
            0% { transform: translateY(0px) scale(1); }
            100% { transform: translateY(-5px) scale(1.05); }
        }
        
        /* Êñ∞ÁöÑÈô∑Èò±Á±ªÂûãÊ†∑Âºè */
        .invisible-trap {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('images/traps/invisible.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 2;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .invisible-trap.revealed {
            opacity: 0.8;
        }
        
        .teleport-trap {
            position: absolute;
            width: 50px;
            height: 50px;
            background-image: url('images/traps/teleport.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 2;
            animation: teleportSpin 2s linear infinite;
        }
        
        @keyframes teleportSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hunter-trap {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('images/traps/hunter.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 2;
            animation: hunterGlow 1s ease-in-out infinite alternate;
        }
        
        @keyframes hunterGlow {
            0% { filter: drop-shadow(0 0 5px #FF4500); }
            100% { filter: drop-shadow(0 0 15px #FF4500); }
        }
        
        .blink-trap {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('images/traps/blink.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 2;
            animation: blinkTrap 3s ease-in-out infinite;
        }
        
        @keyframes blinkTrap {
            0%, 40% { opacity: 1; }
            50%, 90% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        .gravity-trap {
            position: absolute;
            width: 60px;
            height: 60px;
            background-image: url('images/traps/gravity.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 2;
            animation: gravityPull 2s ease-in-out infinite;
        }
        
        @keyframes gravityPull {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .split-trap {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('images/traps/split.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 2;
        }
        
        .mirror-trap {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('images/traps/mirror.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 2;
            animation: mirrorShine 2s linear infinite;
        }
        
        @keyframes mirrorShine {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .freeze-trap {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('images/traps/freeze.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 2;
            animation: freezeEffect 1.5s ease-in-out infinite;
        }
        
        @keyframes freezeEffect {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(0.9); }
        }
        
        .bounce-trap {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('images/traps/bounce.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 2;
            animation: bounceEffect 1s ease-in-out infinite;
        }
        
        @keyframes bounceEffect {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .shrink-trap {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('images/traps/shrink.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 2;
            animation: shrinkEffect 2s ease-in-out infinite;
        }
        
        @keyframes shrinkEffect {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(0.5); }
        }
        
        .speed-trap {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('images/traps/speed.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 2;
            animation: speedEffect 0.5s linear infinite;
        }
        
        @keyframes speedEffect {
            0% { transform: rotate(0deg) scale(1); }
            100% { transform: rotate(360deg) scale(1.1); }
        }
        
        .clone-trap {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('images/traps/clone.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 2;
            animation: cloneEffect 1.5s ease-in-out infinite;
        }
        
        @keyframes cloneEffect {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        /* Èí•ÂåôÊ†∑Âºè */
        .key {
            position: absolute;
            width: 30px;
            height: 30px;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
            animation: keyFloat 2s ease-in-out infinite;
            cursor: pointer;
            filter: drop-shadow(0 0 8px #FFD700);
        }
        
        @keyframes keyFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(10deg); }
        }
        
        .key:hover {
            transform: scale(1.2);
            filter: drop-shadow(0 0 12px #FFD700);
        }
        
        /* ÁàÜÁÇ∏ÁâπÊïà */
        .explosion {
            position: absolute;
            width: 100px;
            height: 100px;
            z-index: 15;
            pointer-events: none;
        }
        
        .explosion::before {
            content: 'üí•';
            font-size: 80px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: explode 0.8s ease-out;
        }
        
        @keyframes explode {
            0% {
                transform: translate(-50%, -50%) scale(0.1);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }
        
        /* ËøáÂÖ≥ÁâπÊïà */
        .level-complete {
            position: absolute;
            width: 100px;
            height: 100px;
            z-index: 15;
            pointer-events: none;
        }
        
        .level-complete::before {
            content: '‚ú®';
            font-size: 60px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: sparkle 1s ease-out;
        }
        
        @keyframes sparkle {
            0% {
                transform: translate(-50%, -50%) scale(0.5) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2) rotate(180deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5) rotate(360deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <h1>ÊãØÊïëZack - MTÂ§ßÂÜíÈô©</h1>
    <div class="level-info">
        Á¨¨ <span id="level">1</span> ÂÖ≥ 
        <span id="progress-info">(ÊúÄÈ´òËÆ∞ÂΩï: Á¨¨ <span id="max-level">1</span> ÂÖ≥)</span>
        <span id="loop-info">üîÑ Á¨¨ <span id="loop-count">3</span> Ê¨°Âæ™ÁéØ</span>
        <span id="key-info" style="display: none;">üóùÔ∏è Èí•Âåô: <span id="key-count">0/3</span></span>
    </div>
    <div class="location-info">
        üìç ÂΩìÂâç‰ΩçÁΩÆ: <span id="location">ÂÖ¨Âè∏ÂâçÂè∞</span>
    </div>
    <div id="message"></div>
    <div id="game-container">
        <div id="player"></div>
        <div id="door"></div>
        <!-- Èô∑Èò±Â∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
    </div>
    <div class="controls">
        <button id="restart-btn">ÈáçÊñ∞ÂºÄÂßãÂΩìÂâçÂÖ≥</button>
        <button id="next-btn" class="hidden">‰∏ã‰∏ÄÂÖ≥</button>
        <button id="level-select-btn">ÈÄâÊã©ÂÖ≥Âç°</button>
                        <button id="sound-toggle-btn">üîä Èü≥Êïà</button>
                <button id="music-toggle-btn">üéµ Èü≥‰πê</button>
                <button id="leaderboard-btn">üèÜ ÊéíË°åÊ¶ú</button>
        <button id="reset-progress-btn">ÈáçÁΩÆËøõÂ∫¶</button>
    </div>
    <div id="level-select" class="hidden">
        <h3>ÈÄâÊã©ÂÖ≥Âç° (Â∑≤Ëß£ÈîÅ: Á¨¨1-<span id="unlocked-levels">1</span>ÂÖ≥)</h3>
        <div id="level-buttons"></div>
        <button id="close-select-btn">ÂÖ≥Èó≠</button>
    </div>
    
    <!-- ÁßªÂä®Á´ØËôöÊãüÊñπÂêëÈîÆ -->
    <div class="mobile-controls">
        <div class="dpad">
            <div class="dpad-btn dpad-up" data-key="ArrowUp">‚Üë</div>
            <div class="dpad-btn dpad-down" data-key="ArrowDown">‚Üì</div>
            <div class="dpad-btn dpad-left" data-key="ArrowLeft">‚Üê</div>
            <div class="dpad-btn dpad-right" data-key="ArrowRight">‚Üí</div>
        </div>
    </div>
    
    <!-- Ëß¶Êë∏Êìç‰ΩúÊèêÁ§∫ -->
    <div class="touch-hint" id="touch-hint">
        üì± <strong>ÊãñÊãΩËßíËâ≤</strong>Âú®Ê∏∏ÊàèÂå∫ÂüüÂÜÖÁßªÂä®<br>
        ËßíËâ≤‰ºöË∑üÈöè‰Ω†ÁöÑÊâãÊåáÂÆûÊó∂ÁßªÂä®<br>
        ÁÇπÂáªÈí•ÂåôÊî∂ÈõÜÔºåÂè≥‰∏ãËßíÊúâËôöÊãüÊñπÂêëÈîÆÂ§áÁî®
    </div>

    <script>
        // Ê∏∏ÊàèÁä∂ÊÄÅ
        const gameState = {
            currentLevel: 1,
            maxLevel: 10,
            maxUnlockedLevel: 1, // ÊúÄÈ´òËß£ÈîÅÂÖ≥Âç°
            player: { x: 50, y: 250 },
            isMoving: false,
            gameOver: false,
            traps: [],
            movingTraps: [],
            specialTraps: [], // ÁâπÊÆäÈô∑Èò±Êï∞ÁªÑ
            keys: [], // ÂΩìÂâçÂÖ≥Âç°ÁöÑÈí•Âåô
            collectedKeys: 0, // Â∑≤Êî∂ÈõÜÁöÑÈí•ÂåôÊï∞Èáè
            requiredKeys: 0, // ÈúÄË¶ÅÊî∂ÈõÜÁöÑÈí•ÂåôÊï∞Èáè
            playerFrozen: false, // Áé©ÂÆ∂ÊòØÂê¶Ë¢´ÂÜ∞ÂÜª
            freezeEndTime: 0, // ÂÜ∞ÂÜªÁªìÊùüÊó∂Èó¥
            levelLayouts: {}, // Â≠òÂÇ®ÊØèÂÖ≥ÁöÑÈô∑Èò±Â∏ÉÂ±Ä
            sessionId: Date.now() + '_' + Math.random().toString(36).substr(2, 9) // ‰ºöËØùID
        };

        // ÊúçÂä°Âô®Á´ØÁªüËÆ°Á≥ªÁªüÔºàÂÆåÂÖ®ÈùôÈªòÔºåÈõ∂ÂΩ±ÂìçÔºâ
        const gameStats = {
            sessionId: null,
            // Ê†πÊçÆÈÉ®ÁΩ≤ÁéØÂ¢ÉËá™Âä®ÈÄâÊã©ÁªüËÆ°ÊúçÂä°Âô®Âú∞ÂùÄ
            statsServerUrl: window.location.hostname === 'xulilong.github.io' 
                ? 'https://rebirth-gyuv.onrender.com'  // GitHub Pages ‰ΩøÁî® Render ÊúçÂä°Âô®
                : window.location.protocol === 'file:' 
                    ? 'http://localhost:3000'           // Êú¨Âú∞Êñá‰ª∂ËÆøÈóÆÊó∂‰ΩøÁî® localhost
                    : window.location.origin,           // ÂÖ∂‰ªñÊÉÖÂÜµ‰ΩøÁî®ÂêåÂüü
            enabled: true, // ÁªüËÆ°ÂºÄÂÖ≥
            
            // ÂàùÂßãÂåñÁªüËÆ°Á≥ªÁªüÔºàÂÆåÂÖ®ÈùôÈªòÔºå‰∏çÈòªÂ°ûÊ∏∏ÊàèÂêØÂä®Ôºâ
            async init() {
                // ‰ΩøÁî®setTimeoutÁ°Æ‰øùÁªüËÆ°ÂàùÂßãÂåñ‰∏ç‰ºöÈòªÂ°ûÊ∏∏ÊàèÂêØÂä®
                setTimeout(async () => {
                    try {
                        await this.trackNewPlayer();
                    } catch (e) {
                        // ÂÆåÂÖ®ÈùôÈªòÂ§ÑÁêÜÔºå‰∏çËæìÂá∫‰ªª‰Ωï‰ø°ÊÅØ
                    }
                }, 100); // Âª∂Ëøü100msÊâßË°åÔºåÁ°Æ‰øùÊ∏∏ÊàèÂÖàÂêØÂä®
            },

            // ÁîüÊàê‰∏¥Êó∂‰ºöËØùIDÔºàÂ¶ÇÊûúÊúçÂä°Âô®‰ºöËØùIDËé∑ÂèñÂ§±Ë¥•Ôºâ
            generateTempSessionId() {
                if (!this.sessionId) {
                    this.sessionId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                }
                return this.sessionId;
            },

            // ÂèëÈÄÅÁªüËÆ°Êï∞ÊçÆÂà∞ÊúçÂä°Âô®ÔºàÂÆåÂÖ®ÈùôÈªòÔºå‰∏çÂΩ±ÂìçÊ∏∏Êàè‰ΩìÈ™åÔºâ
            async sendStats(endpoint, data = {}) {
                // Á°Æ‰øùÊúâ‰ºöËØùID
                const sessionId = this.sessionId || this.generateTempSessionId();
                
                // ‰ΩøÁî®Promise.raceÂÆûÁé∞Ë∂ÖÊó∂ÊéßÂà∂ÔºåÈÅøÂÖçÈïøÊó∂Èó¥Á≠âÂæÖ
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('timeout')), 2000); // 2ÁßíË∂ÖÊó∂
                });
                
                const fetchPromise = fetch(`${this.statsServerUrl}/api/stats/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        referrer: document.referrer || 'direct',
                        ...data
                    })
                });
                
                try {
                    // ‰ΩøÁî®Promise.raceÁ°Æ‰øùÊúÄÂ§öÁ≠âÂæÖ2Áßí
                    const response = await Promise.race([fetchPromise, timeoutPromise]);
                    
                    if (response && response.ok) {
                        return await response.json();
                    }
                } catch (e) {
                    // ÂÆåÂÖ®ÈùôÈªòÂ§ÑÁêÜÔºå‰∏çËæìÂá∫‰ªª‰ΩïÊó•Âøó
                }
                return null;
            },

            // ËøΩË∏™Êñ∞Áé©ÂÆ∂ÔºàÂÆåÂÖ®ÈùôÈªòÔºâ
            async trackNewPlayer() {
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('timeout')), 2000); // 2ÁßíË∂ÖÊó∂
                });
                
                const fetchPromise = fetch(`${this.statsServerUrl}/api/stats/new-player`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        language: navigator.language,
                        screenSize: `${screen.width}x${screen.height}`
                    })
                });
                
                try {
                    const response = await Promise.race([fetchPromise, timeoutPromise]);
                    
                    if (response && response.ok) {
                        const result = await response.json();
                        this.sessionId = result.sessionId;
                    }
                } catch (e) {
                    // ÂÆåÂÖ®ÈùôÈªòÂ§ÑÁêÜÔºå‰∏çËæìÂá∫‰ªª‰ΩïÊó•ÂøóÊàñÈîôËØØ‰ø°ÊÅØ
                }
            },

            // ËøΩË∏™Ê∏∏ÊàèÂºÄÂßãÔºàÂºÇÊ≠•ÈùûÈòªÂ°ûÔºâ
            trackGameStart() {
                if (!this.enabled) return;
                setTimeout(() => this.sendStats('game-start'), 0);
            },

            // ËøΩË∏™ÂÖ≥Âç°Â∞ùËØïÔºàÂºÇÊ≠•ÈùûÈòªÂ°ûÔºâ
            trackLevelAttempt(level, attemptCount) {
                if (!this.enabled) return;
                setTimeout(() => this.sendStats('level-attempt', { level, attemptCount }), 0);
            },

            // ËøΩË∏™ÂÖ≥Âç°ÂÆåÊàêÔºàÂºÇÊ≠•ÈùûÈòªÂ°ûÔºâ
            trackLevelComplete(level, attemptCount) {
                if (!this.enabled) return;
                setTimeout(() => this.sendStats('level-complete', { level, attemptCount }), 0);
            },

            // ËøΩË∏™Èí•ÂåôÊî∂ÈõÜÔºàÂºÇÊ≠•ÈùûÈòªÂ°ûÔºâ
            trackKeyCollected() {
                if (!this.enabled) return;
                setTimeout(() => this.sendStats('key-collected'), 0);
            },

            // ËøΩË∏™CEOÊôãÂçáÔºàÂºÇÊ≠•ÈùûÈòªÂ°ûÔºâ
            trackCEOPromotion() {
                if (!this.enabled) return;
                setTimeout(() => this.sendStats('ceo-promotion'), 0);
            },

            // Êõ¥Êñ∞Áé©ÂÆ∂ËÆ∞ÂΩïÔºàÂºÇÊ≠•ÈùûÈòªÂ°ûÔºâ
            updatePlayerRecord(level, deaths, playerName = null, isCompleted = false) {
                if (!this.enabled) return;
                setTimeout(() => this.sendStats('player-record', { 
                    level, 
                    deaths, 
                    playerName, 
                    isCompleted 
                }), 0);
            }
        };

        // Êú¨Âú∞Â≠òÂÇ®Áõ∏ÂÖ≥ÂáΩÊï∞
        function saveProgress() {
            try {
                localStorage.setItem('wizardGame_maxLevel', gameState.maxUnlockedLevel);
                localStorage.setItem('wizardGame_currentLevel', gameState.currentLevel);
                localStorage.setItem('wizardGame_loopCount', loopCount);
            } catch (e) {
                console.log('Êó†Ê≥ï‰øùÂ≠òËøõÂ∫¶:', e);
            }
        }

        function loadProgress() {
            try {
                const savedMaxLevel = localStorage.getItem('wizardGame_maxLevel');
                const savedCurrentLevel = localStorage.getItem('wizardGame_currentLevel');
                const savedLoopCount = localStorage.getItem('wizardGame_loopCount');
                
                if (savedMaxLevel) {
                    gameState.maxUnlockedLevel = parseInt(savedMaxLevel);
                }
                if (savedCurrentLevel) {
                    gameState.currentLevel = Math.min(parseInt(savedCurrentLevel), gameState.maxUnlockedLevel);
                }
                if (savedLoopCount) {
                    loopCount = parseInt(savedLoopCount);
                } else {
                    loopCount = 3; // ÈªòËÆ§ÂÄº
                }
            } catch (e) {
                console.log('Êó†Ê≥ïÂä†ËΩΩËøõÂ∫¶:', e);
            }
        }

        function resetProgress() {
            try {
                localStorage.removeItem('wizardGame_maxLevel');
                localStorage.removeItem('wizardGame_currentLevel');
                localStorage.removeItem('wizardGame_loopCount');
                gameState.maxUnlockedLevel = 1;
                gameState.currentLevel = 1;
                loopCount = 3; // ÈáçÁΩÆÂæ™ÁéØÊ¨°Êï∞
                updateProgressDisplay(); // Êõ¥Êñ∞ÊòæÁ§∫
            } catch (e) {
                console.log('Êó†Ê≥ïÈáçÁΩÆËøõÂ∫¶:', e);
            }
        }

        // ÂÖ≥Âç°‰ΩçÁΩÆ‰ø°ÊÅØ - MTÂÖ¨Âè∏Êé¢Á¥¢‰πãÊóÖ
        const levelLocations = {
            1: "üè¢ ÂÖ¨Âè∏ÂâçÂè∞ - ÂàùÊù•‰πçÂà∞",
            2: "üçΩÔ∏è Á¨¨‰∏ÄÈ£üÂ†Ç - ËßÖÈ£üÊó∂ÂÖâ", 
            3: "üìã ‰ºöËÆÆÂÆ§-ÊñáÊòé - ÊñáÂåñÊ¥óÁ§º",
            4: "üß© ‰ºöËÆÆÂÆ§-‰πêÈ´ò - ÂàõÊÑèÁ©∫Èó¥",
            5: "üèùÔ∏è ‰ºöËÆÆÂÆ§-ÂõûÈü≥Áæ§Â≤õ - ÊÄùÁª¥Á¢∞Êíû",
            6: "üçú Á¨¨‰∫åÈ£üÂ†Ç - ËÉΩÈáèË°•Áªô",
            7: "üíª HOPÈ°πÁõÆÁªÑ - ÊäÄÊúØÂâçÊ≤ø",
            8: "üöÄ JUMPÈ°πÁõÆÁªÑ - ÊïèÊç∑ÂºÄÂèë",
            9: "‚öôÔ∏è ÊäÄÊúØÈÉ®Ê†∏ÂøÉ - Á≥ªÁªü‰∏≠Êû¢",
            10: "üëë CEOÂäûÂÖ¨ÂÆ§ - ÊúÄÁªàÂÜ≥Êàò"
        };

        // ÂÖ≥Âç°ÂØπËØù‰ø°ÊÅØ - Ê∑±Â∫¶ÂâßÊÉÖ‰ΩìÈ™å
        const levelDialogs = {
            1: {
                title: "üîÑ ÂÖ¨Âè∏ÂâçÂè∞-Êó∂Á©∫Âæ™ÁéØÁöÑÂºÄÂßã",
                content: () => `Ê¨¢ËøéÊù•Âà∞Magic TavernÔºÅÂí¶ÔºüËøôÁßç‰ººÊõæÁõ∏ËØÜÁöÑÊÑüËßâ...Á≠âÁ≠âÔºåËøôÂ∑≤ÁªèÊòØÁ¨¨${loopCount}Ê¨°Âæ™ÁéØ‰∫ÜÔºüÔºÅÊàëÊòØ‰∏çÊòØÂú®ÂÅöÊ¢¶ÔºüËøòÊòØÊò®ÊôöÂä†Áè≠Â§™Êôö‰∫ßÁîüÂπªËßâ‰∫ÜÔºüÔºÅ

üéÆ ‰ªªÂä°ÊèêÁ§∫ÔºöCEO ZackÂèØËÉΩÈÅáÂà∞‰∫ÜÈ∫ªÁÉ¶ÔºåÈúÄË¶Å‰Ω†ÁöÑÂ∏ÆÂä©ÔºÅ
üí° Êìç‰ΩúÊåáÂçóÔºöÁî®ÊñπÂêëÈîÆÊéßÂà∂ËßíËâ≤ÁßªÂä®ÔºåÈÅøÂºÄÁ∫¢Ëâ≤ÈöúÁ¢çÁâ©ÔºåÂà∞ËææÁªøËâ≤Âá∫Âè£Â∞±ËÉΩËøõÂÖ•‰∏ã‰∏ÄÂÖ≥ÔºÅ`
            },
            2: {
                title: "üçΩÔ∏è MT‰∫∫ÁöÑÊó•Â∏∏-Âπ≤È•≠Á¨¨‰∏Ä",
                content: `Âæ™ÁéØÔºüÂºÄ‰ªÄ‰πàÁé©Á¨ëÔºü‰Ωú‰∏∫‰∏Ä‰∏™ÊâìÂ∑•‰∫∫ÔºåËøòÊòØÂπ≤È•≠ÈáçË¶ÅÔºÅ12ÁÇπÂçä‰∫ÜÔºåÂÜ≤ÔºÅÔºÅÔºÅ

üçú ÂÖ≥Âç°ÁâπËâ≤ÔºöÂú®ÁæéÈ£üÁöÑËØ±ÊÉë‰∏≠‰øùÊåÅ‰∏ìÊ≥®Ôºå‰∏çË¶ÅË¢´È¶ôÂë≥ÂàÜÊï£Ê≥®ÊÑèÂäõÔºÅ
‚ö†Ô∏è ÈöæÂ∫¶ÊèêÂçáÔºöÂá∫Áé∞‰∫ÜÁßªÂä®ÁöÑÈöúÁ¢çÁâ©ÔºÅÂÆÉ‰ª¨Â∞±ÂÉèÂøôÁ¢åÁöÑÊúçÂä°Âëò‰∏ÄÊ†∑Êù•ÂõûÁ©øÊ¢≠ÔºåÂ∞èÂøÉÂà´Êíû‰∏äÔºÅ`
            },
            3: {
                title: "üìã ÊñáÊòé-‰ºÅ‰∏öÊñáÂåñÁöÑÂäõÈáè",
                content: `ÊñáÊòé‰ºöËÆÆÂÆ§ÔºåÂ¢ô‰∏äË¥¥ÁùÄ‰ºÅ‰∏öÊñáÂåñÊ†áËØ≠ÔºåÁúãËµ∑Êù•ÂæàÊúâÁ≤æÁ•ûÔºÅÁúüËØö„ÄÅËøõÂèñ„ÄÅË¥üË¥£„ÄÅÈΩêÂøÉÂçèÂäõ...Ëøô‰∫õËØçÊàëÈÉΩËÆ§ËØÜÔºåÁªÑÂêàÂú®‰∏ÄËµ∑Â∞±ÂæàÊúâÂäõÈáèÁöÑÊÑüËßâ„ÄÇ

üóùÔ∏è Êñ∞‰ªªÂä°ÔºöÂí¶Ôºü‰ºöËÆÆÂÆ§ÈáåÊï£ËêΩÁùÄ‰∏Ä‰∫õÈáëËâ≤ÁöÑÈí•ÂåôÔºÅÁúãËµ∑Êù•ÂæàÈáçË¶ÅÁöÑÊ†∑Â≠êÔºåÊàëÈúÄË¶ÅÊî∂ÈõÜ3ÊääÈí•ÂåôÊâçËÉΩËøõÂÖ•‰∏ã‰∏ÄÂÖ≥ÔºÅ
‚ö° Â∞èÂ∞èÊåëÊàòÔºö‰ºöËÆÆÂÆ§ÈáåÁöÑÈöúÁ¢çÁâ©ÂèòÂ§ö‰∫ÜÔºåÂ∞±ÂÉèÂºÄ‰ºöÊó∂Á™ÅÁÑ∂ÂÜíÂá∫ÁöÑÊñ∞ÊÉ≥Ê≥ï‰∏ÄÊ†∑ÔºåÈúÄË¶ÅÁÅµÊ¥ªÂ∫îÂØπÔºÅ`
            },
            4: {
                title: "üß© ‰πêÈ´ò-ÂàõÊÑèÊó†ÈôêÁöÑ‰πêÈ´òÁ©∫Èó¥",
                content: `‰πêÈ´ò‰ºöËÆÆÂÆ§ÔºÅÂìáÔºåËøôÈáåÁöÑ‰πêÈ´òÊ®°ÂûãÂ•ΩÁ≤æËá¥Ôºå‰∏ÄÂÆöËä±‰∫Ü‰∏çÂ∞ëÂøÉÊÄùÔºÅÈÇ£‰∏™ÂüéÂ†°Ê®°Âûã...Âí¶ÔºåËøô‰∏™ÁªìÊûÑÊÄé‰πàËøô‰πàÁúºÁÜüÔºüËØ•‰∏ç‰ºöÊòØÊåâÊàë‰ª¨ÁöÑÁ≥ªÁªüÊû∂ÊûÑÊê≠ÁöÑÂêßÔºü

üóùÔ∏è ÁªßÁª≠Êî∂ÈõÜÔºöËøôÈáå‰πüÊúâ3ÊääÈí•ÂåôÈúÄË¶ÅÊî∂ÈõÜÔºÅÁúãÊù•Ëøô‰∫õÈí•ÂåôÂØπÊãØÊïëZackÂæàÈáçË¶ÅÔºÅ
üé® Ê∏∏ÊàèÂøÉÂæóÔºöÂ∞±ÂÉèÊê≠‰πêÈ´òÈúÄË¶ÅËÄêÂøÉ‰∏ÄÊ†∑ÔºåÈÄöËøáËøô‰∫õÈöúÁ¢ç‰πüÈúÄË¶ÅÁªÜÂøÉËßÑÂàíË∑ØÁ∫øÔºÅ`
            },
            5: {
                title: "üèùÔ∏è ÂõûÈü≥Áæ§Â≤õ-Êô∫ÊÖßÁ¢∞Êíû",
                content: `ÂõûÈü≥Áæ§Â≤õ‰ºöËÆÆÂÆ§ÔºåËøôÂêçÂ≠óËµ∑ÂæóÁúüÊúâËØóÊÑèÔºÅ‰∏ÄÂê¨Â∞±Áü•ÈÅìÊòØ‰∏™ÊúâÊñáÂåñÁöÑ‰∫∫ÊÉ≥Âá∫Êù•ÁöÑ„ÄÇÂ¢ô‰∏äÁöÑÊµ∑Ê¥ã‰∏ªÈ¢òË£ÖÈ•∞ÁîªÂæàÊºÇ‰∫ÆÔºåËìùËâ≤Ë∞ÉÁúãÁùÄÂ∞±ËÆ©‰∫∫ÂøÉÊÉÖËàíÁïÖ„ÄÇ"ÂõûÈü≥"Ëøô‰∏™Ê¶ÇÂøµ‰πüÂæàÊúâÊÑèÊÄùÔºÅ

üóùÔ∏è ÊúÄÂêéÊî∂ÈõÜÔºöËøôÊòØÊúÄÂêé‰∏Ä‰∏™ÈúÄË¶ÅÊî∂ÈõÜÈí•ÂåôÁöÑÊàøÈó¥‰∫ÜÔºÅÊî∂ÈõÜÂÆåËøô3ÊääÈí•ÂåôÔºåÊàëÂ∞±ËÉΩÁªßÁª≠ÂâçËøõÊãØÊïëZackÔºÅ
üå™Ô∏è Á≠ñÁï•ÂçáÁ∫ßÔºöÂ∞±ÂÉèÂú®Â≤õÂ±øÈó¥Ëà™Ë°å‰∏ÄÊ†∑ÔºåÈúÄË¶ÅÊâæÂà∞ÊúÄ‰Ω≥Ë∑ØÂæÑÊù•Â∫îÂØπËøô‰∫õË∂äÊù•Ë∂äÂ§çÊùÇÁöÑÈöúÁ¢çÔºÅ`
            },
            6: {
                title: "üçú Á¨¨‰∫åÈ£üÂ†Ç-ËÉΩÈáèË°•ÁªôÁ´ô",
                content: `‰∏ÄËΩ¨ÁúºÂäüÂ§´ÂèàÂà∞È•≠ÁÇπ‰∫ÜÔºåÂéªÂêÉÁÇπÂ•ΩÂêÉÁöÑÔºÅÁ¨¨‰∫åÈ£üÂ†ÇÔºåËøôÈáåÈÄâÊã©Êõ¥Â§öÔºå‰∫∫Ê∞î‰πüÊõ¥Êó∫ÔºÅÂπ≤È•≠Âπ≤È•≠ÔºÅÔºÅÔºÅ

‚ö° Ê¥ªÂäõÊª°Êª°ÔºöÂêÉÈ•±‰∫ÜÊûúÁÑ∂Á≤æÁ•ûÁôæÂÄçÔºÅ‰∏çËøáËøô‰∫õÈöúÁ¢çÁâ©Â•ΩÂÉè‰πüË∑üÁùÄ"ÂçáÁ∫ß"‰∫ÜÔºåÊåëÊàòÊõ¥Â§ß‰∫ÜÔºÅ`
            },
            7: {
                title: "üíª HOPÈ°πÁõÆÁªÑ - ÊäÄÊúØÂâçÊ≤ø",
                content: `HOPÈ°πÁõÆÁªÑÔºåÂ§ßÂ±èÂπï‰∏äÂêÑÁßçËä±ÈáåËÉ°Âì®ÁöÑÂõæË°®ÔºåÁúãËµ∑Êù•ÂæàÂéâÂÆ≥ÁöÑÊ†∑Â≠êÔºåÁ®ãÂ∫èÂëò‰ª¨Âú®ÁñØÁãÇÊï≤ÈîÆÁõòÔºå‰∏çÁü•ÈÅìÊòØÂú®ÂÜô‰ª£Á†ÅËøòÊòØÂú®ËÅäÂ§©Êë∏È±º„ÄÇ

üö® BugË≠¶Êä•ÔºöÁ≥ªÁªüÂºÄÂßãÊä•Ë≠¶‰∫ÜÔºÅËøô‰∫õÁßªÂä®ÁöÑÈöúÁ¢çÁâ©ËØ•‰∏ç‰ºöÂ∞±ÊòØ‰º†ËØ¥‰∏≠ÁöÑ"Á∫ø‰∏äBug"ÂêßÔºü`
            },
            8: {
                title: "üöÄ JUMPÈ°πÁõÆÁªÑ - ÊïèÊç∑ÂºÄÂèë",
                content: `JUMPÈ°πÁõÆÁªÑÔºÅËøôÂêçÂ≠ó‰∏ÄÂê¨Â∞±ÂæàÊúâÊ¥ªÂäõÔºåÂÖÖÊª°‰∫Ü"Ë∑≥Ë∑É"ÁöÑÊÑüËßâÔºÅ

üèÉ‚Äç‚ôÇÔ∏è ÈÄüÂ∫¶ÊåëÊàòÔºöÂú®ËøôÁßçÂø´ËäÇÂ•èÁöÑÁéØÂ¢É‰∏ãÔºåÊàë‰πüË¶ÅÂä†Âø´ÈÄüÂ∫¶‰∫ÜÔºÅËøô‰∫õÈöúÁ¢çÁâ©ÂèòÂåñÁúüÂø´ÔºÅ`
            },
            9: {
                title: "‚öôÔ∏è ÊäÄÊúØÈÉ® - Á≥ªÁªü‰∏≠Êû¢",
                content: `ÊäÄÊúØÈÉ®Ê†∏ÂøÉÂå∫ÂüüÔºÅËøôÈáåÂ∞±ÊòØMTÁöÑ"Â§ßËÑë‰∏≠Êû¢"ÔºÅÂó°Âó°‰ΩúÂìçÁöÑÊúçÂä°Âô®‰ª¨Ê≠£Âú®ËæõÂã§Â∑•‰ΩúÔºåÂ∞±ÂÉèÊ∞∏‰∏çÂÅúÊ≠áÁöÑÂøÉËÑèÔºÅ

‚ö†Ô∏è ÁªàÊûÅÊåëÊàòÔºöÂìáÔºåÁ≥ªÁªüË≠¶Êä•Â£∞Ê≠§Ëµ∑ÂΩº‰ºèÔºÅÁúãÊù•ÁúüÁöÑÈÅáÂà∞Â§ßÈóÆÈ¢ò‰∫ÜÔºåÊòØÊó∂ÂÄôÂ±ïÁé∞ÁúüÊ≠£ÁöÑÊäÄÊúØ‰∫ÜÔºÅ`
            },
            10: {
                title: "üî• Âú∞Áã±Ê®°Âºè - ÁªàÊûÅÊåëÊàò",
                content: `‚ö†Ô∏è Ë≠¶ÂëäÔºö‰Ω†Âç≥Â∞ÜËøõÂÖ•Âú∞Áã±Ê®°ÂºèÔºÅËøôÊòØÊúÄÁªàÁöÑËÄÉÈ™åÔºÅ

üíÄ CEOÂäûÂÖ¨ÂÆ§Â∑≤Ë¢´ÊÅ∂È≠îÂåñÔºåÁ©∫Ê∞î‰∏≠Âº•Êº´ÁùÄÂç±Èô©ÁöÑÊ∞îÊÅØ...

üî• ËøôÈáåÁöÑ‰∏ÄÂàáÈÉΩÂèòÂæóÊõ¥Âä†Âç±Èô©ÂíåËØ°ÂºÇÔºåÈô∑Èò±ÂØÜÂ∏ÉÔºåÂç±Êú∫Âõõ‰ºèÔºÅ

üëë ‰ΩÜÊòØZackÂ∞±Âú®ËøôÈáåÁ≠âÁùÄ‰Ω†ÁöÑÊãØÊïëÔºÅÂè™ÊúâÁúüÊ≠£ÁöÑÂãáÂ£´ÊâçËÉΩÈÄöËøáËøôÊúÄÂêéÁöÑËØïÁÇºÔºÅ

üéØ ÊúÄÂêéÁöÑ‰ΩøÂëΩÔºöÂáÜÂ§áÂ•ΩËøéÊé•‰Ω†‰∫∫Áîü‰∏≠ÊúÄÂ§ßÁöÑÊåëÊàò‰∫ÜÂêóÔºü`
            }
        };

        // DOMÂÖÉÁ¥†
        const levelDisplay = document.getElementById('level');
        const maxLevelDisplay = document.getElementById('max-level');
        const unlockedLevelsDisplay = document.getElementById('unlocked-levels');
        const locationDisplay = document.getElementById('location');
        const messageDisplay = document.getElementById('message');
        const loopCountDisplay = document.getElementById('loop-count');
        const keyInfoDisplay = document.getElementById('key-info');
        const keyCountDisplay = document.getElementById('key-count');
        const gameContainer = document.getElementById('game-container');
        const player = document.getElementById('player');
        const door = document.getElementById('door');
        const nextBtn = document.getElementById('next-btn');
        const restartBtn = document.getElementById('restart-btn');
        const levelSelectBtn = document.getElementById('level-select-btn');
        const soundToggleBtn = document.getElementById('sound-toggle-btn');
        const musicToggleBtn = document.getElementById('music-toggle-btn');
        const resetProgressBtn = document.getElementById('reset-progress-btn');
        const levelSelectModal = document.getElementById('level-select');
        const levelButtonsContainer = document.getElementById('level-buttons');
        const closeSelectBtn = document.getElementById('close-select-btn');

        // Ê∏∏ÊàèÂèòÈáè
        let gameWidth = 800;
        let gameHeight = 500;
        let loopCount = 3; // ÂàùÂßãÂæ™ÁéØÊ¨°Êï∞‰∏∫3
        let doorRect = door.getBoundingClientRect();
        let basePlayerSpeed = 8;
        let playerSpeed = 8;
        let animationFrame;
        let trapInterval;
        
        // Áé©ÂÆ∂ËÆ∞ÂΩïËøΩË∏™
        let levelDeaths = {}; // ËÆ∞ÂΩïÊØèÂÖ≥ÁöÑÊ≠ª‰∫°Ê¨°Êï∞
        let currentLevelDeaths = 0; // ÂΩìÂâçÂÖ≥Âç°ÁöÑÊ≠ª‰∫°Ê¨°Êï∞
        
        // Âä®ÊÄÅË∞ÉÊï¥Ê∏∏ÊàèÂå∫ÂüüÂ§ßÂ∞è
        function updateGameDimensions() {
            const container = document.getElementById('game-container');
            const rect = container.getBoundingClientRect();
            gameWidth = rect.width;
            gameHeight = rect.height;
            doorRect = door.getBoundingClientRect();
            
            // Âú®Â∞èÂ±èÂπï‰∏äË∞ÉÊï¥Áé©ÂÆ∂ÂíåÈô∑Èò±ÁöÑÂ§ßÂ∞è
            if (window.innerWidth <= 480) {
                // Ë∂ÖÂ∞èÂ±èÂπï
                player.style.transform = 'scale(0.8)';
            } else if (window.innerWidth <= 850) {
                // Â∞èÂ±èÂπï
                player.style.transform = 'scale(0.9)';
            } else {
                // Ê≠£Â∏∏Â±èÂπï
                player.style.transform = 'scale(1)';
            }
        }
        
        // Èü≥ÊïàÁ≥ªÁªü
        let audioContext;
        let soundEnabled = true;
        
        // ËÉåÊôØÈü≥‰πêÁ≥ªÁªü
        let backgroundMusic;
        let musicEnabled = true;
        let musicVolume = 0.1; // ËÉåÊôØÈü≥‰πêÈü≥ÈáèÔºà10%Ôºâ

        // ÊòæÁ§∫ÂØπËØùÊ°Ü
        function showDialog(title, content, callback) {
            const overlay = document.createElement('div');
            overlay.className = 'dialog-overlay';
            
            overlay.innerHTML = `
                <div class="dialog-box">
                    <div class="dialog-title">${title}</div>
                    <div class="dialog-content">${content}</div>
                    <button class="dialog-btn">ÂºÄÂßãÂÜíÈô©ÔºÅ</button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            const btn = overlay.querySelector('.dialog-btn');
            btn.addEventListener('click', () => {
                document.body.removeChild(overlay);
                if (callback) callback();
            });
        }

        // ÊòæÁ§∫ZackÊãØÊïëÊàêÂäüÂØπËØùÊ°Ü
        function showZackSuccessDialog() {
            const overlay = document.createElement('div');
            overlay.className = 'zack-success-overlay';
            
            overlay.innerHTML = `
                <div class="zack-success-box">
                    <div class="zack-avatar" id="ceo-avatar"></div>
                    <div class="zack-success-title">üéâ ÊãØÊïëÊàêÂäüÔºÅ</div>
                    <div class="zack-success-content">
                        ÊÅ≠Âñú‰Ω†ÔºÅÁªèËøáÈáçÈáçÂõ∞ÈöæÔºå‰Ω†Áªà‰∫éÊàêÂäüÊãØÊïë‰∫ÜZackÔºÅ
                        <br><br>
                        <strong>Zack:</strong> "Â§™ÊÑüË∞¢‰Ω†‰∫ÜÔºÅÊàëË¢´Âõ∞Âú®Ëøô‰∏™Âæ™ÁéØ‰∏≠Â•Ω‰πÖ‰∫ÜÔºÅ‰Ω†Â±ïÁé∞Âá∫‰∫Ü‰Ω†ÁöÑÊô∫ÊÖßÂíåÊï¢‰∫éÂÜíÈô©ÁöÑÁ≤æÁ•ûÔºÅ"
                        <br><br>
                        <strong>Zack:</strong> "‰ªé‰ªäÂ§©Ëµ∑Ôºå‰Ω†Â∞±ÊòØMagic TavernÁöÑÊñ∞‰ªªCEOÔºÅËÆ©Êàë‰ª¨‰∏ÄËµ∑ÁßâÊâø'ÁúüËØö„ÄÅËøõÂèñ„ÄÅË¥üË¥£„ÄÅÈΩêÂøÉÂçèÂäõ'ÁöÑÁêÜÂøµÔºåÂ∏¶È¢ÜÂÖ¨Âè∏Ëµ∞ÂêëÊõ¥ÁæéÂ•ΩÁöÑÊú™Êù•ÔºÅ"
                        <br><br>
                        <strong>Zack:</strong> "ÂØπ‰∫ÜÔºåËÉΩÂëäËØâÊàë‰Ω†ÁöÑÂêçÂ≠óÂêóÔºüÊàëÊÉ≥Âú®Â∞±ËÅåÂÖ∏Á§º‰∏äÊ≠£Âºè‰ªãÁªç‰Ω†ÔºÅ"
                        <br><br>
                        <div class="name-input-container">
                            <label for="player-name">ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÂßìÂêçÔºö</label>
                            <input type="text" id="player-name" placeholder="ËæìÂÖ•ÊÇ®ÁöÑÂßìÂêç" maxlength="20" />
                        </div>
                        <br>
                        üèÜ <strong>ÊàêÂ∞±Ëß£ÈîÅÔºö</strong> Âæ™ÁéØÁªàÁªìËÄÖ - ÊàêÂäüÊâìÁ†¥Êó∂Èó¥Âæ™ÁéØÔºåÊãØÊïëCEOÔºÅ
                        <br>
                        üëë <strong>Êñ∞Ë∫´‰ªΩÔºö</strong> MTÂÖ¨Âè∏CEO
                    </div>
                    <button class="zack-success-btn">Êé•ÂèóCEOËÅå‰ΩçÔºÅ</button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Ê£ÄÊµãCEOÂ§¥ÂÉèÂõæÁâáÊòØÂê¶Â≠òÂú®ÔºåÂ¶ÇÊûú‰∏çÂ≠òÂú®Âàô‰ΩøÁî®emoji
            const ceoAvatar = overlay.querySelector('#ceo-avatar');
            const testImg = new Image();
            testImg.onload = function() {
                // ÂõæÁâáÂä†ËΩΩÊàêÂäüÔºå‰ΩøÁî®ËÉåÊôØÂõæÁâá
                console.log('CEOÂ§¥ÂÉèÂä†ËΩΩÊàêÂäü');
            };
            testImg.onerror = function() {
                // ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®emoji‰Ωú‰∏∫ÂêéÂ§á
                console.log('CEOÂ§¥ÂÉèÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®emojiÂêéÂ§á');
                ceoAvatar.classList.add('fallback');
                ceoAvatar.textContent = 'üë®‚Äçüíº';
            };
            testImg.src = 'images/zack.jpeg';
            
            // Ëá™Âä®ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°Ü
            const nameInput = overlay.querySelector('#player-name');
            setTimeout(() => {
                nameInput.focus();
            }, 500);
            
            // ÊîØÊåÅÂõûËΩ¶ÈîÆÁ°ÆËÆ§
            nameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleCEOAcceptance();
                }
            });
            
            const btn = overlay.querySelector('.zack-success-btn');
            btn.addEventListener('click', handleCEOAcceptance);
            
            function handleCEOAcceptance() {
                const playerName = nameInput.value.trim() || 'ÂãáÊï¢ÁöÑÂÜíÈô©ËÄÖ';
                document.body.removeChild(overlay);
                // ÊòæÁ§∫CEOÂ∞±ËÅå‰ª™ÂºèÔºå‰º†ÂÖ•Áé©ÂÆ∂ÂßìÂêç
                showCEOCeremony(playerName);
            }
        }

        // ÊòæÁ§∫CEOÂ∞±ËÅå‰ª™Âºè
        function showCEOCeremony(playerName = 'ÂãáÊï¢ÁöÑÂÜíÈô©ËÄÖ') {
            const overlay = document.createElement('div');
            overlay.className = 'ceo-ceremony-overlay';
            
            overlay.innerHTML = `
                <div class="fireworks"></div>
                <div class="mt-logo">MT</div>
                <div class="ceo-title">üëë ${playerName} CEOÂ∞±ËÅåÂÖ∏Á§º</div>
                <div class="ceo-subtitle">
                    ÁÉ≠ÁÉàÊ¨¢Ëøé <strong>${playerName}</strong> Âä†ÂÖ•Magic TavernÈ¢ÜÂØºÂõ¢ÈòüÔºÅ<br>
                    ÁßâÊâø"ÁúüËØö„ÄÅËøõÂèñ„ÄÅË¥üË¥£„ÄÅÈΩêÂøÉÂçèÂäõ"ÁöÑ‰ª∑ÂÄºËßÇÔºå<br>
                    ËÆ©Êàë‰ª¨‰∏ÄËµ∑ÂàõÈÄ†Êõ¥ÁæéÂ•ΩÁöÑÊú™Êù•ÔºÅ
                </div>
                <div class="ceo-welcome">
                    üéä <strong>Zack:</strong> "ÂêÑ‰ΩçÂêå‰∫ãÔºåËÆ©Êàë‰ª¨ÁÉ≠ÁÉàÊ¨¢ËøéÊàë‰ª¨ÁöÑÊñ∞‰ªªCEO - ${playerName}ÔºÅ"<br>
                    üëè <strong>ÂÖ®‰ΩìÂëòÂ∑•:</strong> "Ê¨¢Ëøé ${playerName} CEOÔºÅ"
                </div>
                <div class="mt-values">
                    <div class="value-item">
                        <span class="value-icon">üíé</span>
                        <div>ÁúüËØö Sincere</div>
                        <div class="value-desc">ÂÆû‰∫ãÊ±ÇÊòØÔºå‰∏ªÂä®Ê≤üÈÄö</div>
                    </div>
                    <div class="value-item">
                        <span class="value-icon">üöÄ</span>
                        <div>ËøõÂèñ Progressive</div>
                        <div class="value-desc">ÊåÅÁª≠Â≠¶‰π†ÔºåÁ≤æÁõäÊ±ÇÁ≤æ</div>
                    </div>
                    <div class="value-item">
                        <span class="value-icon">üõ°Ô∏è</span>
                        <div>Ë¥üË¥£ Reliable</div>
                        <div class="value-desc">ÂÖ¢ÂÖ¢‰∏ö‰∏öÔºåÂãá‰∫éÊãÖÂΩì</div>
                    </div>
                    <div class="value-item">
                        <span class="value-icon">ü§ù</span>
                        <div>ÈΩêÂøÉÂçèÂäõ Team-oriented</div>
                        <div class="value-desc">Áõ∏‰∫íÂçèÂä©ÔºåÂ§ßÂ±Ä‰∏∫Èáç</div>
                    </div>
                </div>
                <button class="continue-btn">${playerName} ÂºÄÂßãCEO‰πãÊóÖÔºÅ</button>
            `;
            
            document.body.appendChild(overlay);
            
            // ÂàõÂª∫ÁÉüËä±ÊïàÊûú
            createFireworks(overlay.querySelector('.fireworks'));
            
            // ÂàõÂª∫ÂΩ©Â∏¶ÊïàÊûú
            createConfetti(overlay);
            
            const btn = overlay.querySelector('.continue-btn');
            btn.addEventListener('click', () => {
                // Á°Æ‰øùÊúÄÂêé‰∏ÄÂÖ≥ÁöÑÊ≠ª‰∫°Ê¨°Êï∞‰πüË¢´ËÆ∞ÂΩï
                levelDeaths[10] = currentLevelDeaths;
                
                // ËÆ°ÁÆóÊÄªÊ≠ª‰∫°Ê¨°Êï∞
                const totalDeaths = Object.values(levelDeaths).reduce((sum, deaths) => sum + deaths, 0);
                
                // ÂèëÈÄÅÂÆåÊï¥ÁöÑÊ∏∏ÊàèÂÆåÊàêËÆ∞ÂΩïÂà∞ÊúçÂä°Âô®
                // ËøôÈáåÊàë‰ª¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂÆåÊï¥Ê∏∏ÊàèËÆ∞ÂΩïÔºåÂåÖÂê´ÊâÄÊúâÂÖ≥Âç°ÁöÑÊ≠ª‰∫°Êï∞ÊçÆ
                if (gameStats.enabled) {
                    setTimeout(() => gameStats.sendStats('game-complete', { 
                        playerName: playerName,
                        totalDeaths: totalDeaths,
                        levelDeaths: levelDeaths,
                        completedAt: new Date().toISOString()
                    }), 0);
                }
                
                // ËøΩË∏™CEOÊôãÂçáÁªüËÆ°ÔºàÂÆåÂÖ®ÈùôÈªòÔºå‰∏çÂΩ±ÂìçÊ∏∏ÊàèÔºâ
                gameStats.trackCEOPromotion();
                
                document.body.removeChild(overlay);
                // ÈáçÁΩÆÊâÄÊúâÊ∏∏ÊàèÊï∞ÊçÆÂíåÁºìÂ≠òÔºå‰º†ÂÖ•Áé©ÂÆ∂ÂßìÂêç
                resetAllGameData(playerName);
            });
        }

        // ÈáçÁΩÆÊâÄÊúâÊ∏∏ÊàèÊï∞ÊçÆÂíåÁºìÂ≠ò
        function resetAllGameData(playerName = 'ÂãáÊï¢ÁöÑÂÜíÈô©ËÄÖ') {
            // Ê∏ÖÈô§ÊâÄÊúâÊú¨Âú∞Â≠òÂÇ®Êï∞ÊçÆ
            localStorage.removeItem('wizardGame_currentLevel');
            localStorage.removeItem('wizardGame_maxLevel');
            localStorage.removeItem('wizardGame_loopCount');
            localStorage.removeItem('wizardGame_soundEnabled');
            localStorage.removeItem('wizardGame_musicEnabled');
            localStorage.removeItem('wizardGame_musicVolume');
            localStorage.removeItem('wizardGame_playerSpeed');
            localStorage.removeItem('wizardGame_gameStarted');
            
            // ÂÅúÊ≠¢ÊâÄÊúâÊ∏∏ÊàèÂæ™ÁéØÂíåÂÆöÊó∂Âô®
            if (trapInterval) {
                clearInterval(trapInterval);
                trapInterval = null;
            }
            
            // ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅÂà∞ÂàùÂßãÁä∂ÊÄÅ
            gameState = {
                currentLevel: 1,
                maxUnlockedLevel: 1,
                gameOver: false,
                player: { x: 50, y: 50 },
                keys: [],
                traps: []
            };
            
            // ÈáçÁΩÆÂÖ∂‰ªñÊ∏∏ÊàèÂèòÈáè
            loopCount = 3;
            playerSpeed = basePlayerSpeed;
            gameStarted = false;
            
            // ÈáçÁΩÆÊ≠ª‰∫°ËÆ°Êï∞Âô®
            levelDeaths = {};
            currentLevelDeaths = 0;
            
            // Ê∏ÖÁ©∫Ê∏∏ÊàèÂå∫ÂüüÔºåÁßªÈô§ÊâÄÊúâÈô∑Èò±ÂíåÈí•Âåô
            const gameContainer = document.getElementById('game-container');
            const elementsToRemove = gameContainer.querySelectorAll('.trap, .key, .moving-trap');
            elementsToRemove.forEach(element => {
                if (element.parentNode) {
                    element.parentNode.removeChild(element);
                }
            });
            
            // ÈáçÁΩÆÁé©ÂÆ∂‰ΩçÁΩÆÂíåÊ†∑Âºè
            player.style.left = '50px';
            player.style.top = '50px';
            player.style.transform = 'scale(1)'; // ÈáçÁΩÆÁº©Êîæ
            
            // ÈáçÁΩÆÊ∏∏ÊàèÂÆπÂô®Ê†∑ÂºèÔºàÁßªÈô§Âú∞Áã±Ê®°ÂºèÔºâ
            gameContainer.classList.remove('hell-mode');
            
            // ÈáçÁΩÆÊòæÁ§∫
            messageDisplay.textContent = 'Ê¨¢ËøéÊù•Âà∞ÊãØÊïëZack - MTÂ§ßÂÜíÈô©ÔºÅÁÇπÂáªÂºÄÂßãÊ∏∏ÊàèÔºÅ';
            updateProgressDisplay();
            
            // ÈáçÊñ∞ÊòæÁ§∫ÂºÄÂßãÊåâÈíÆ
            const startBtn = document.getElementById('startBtn');
            if (startBtn) {
                startBtn.style.display = 'block';
                startBtn.textContent = 'ÂºÄÂßãÊ∏∏Êàè';
            }
            
            // ÈöêËóèÂÖ∂‰ªñÊåâÈíÆ
            const nextBtn = document.getElementById('nextBtn');
            const restartBtn = document.getElementById('restartBtn');
            if (nextBtn) nextBtn.style.display = 'none';
            if (restartBtn) restartBtn.style.display = 'none';
            
            // ÂÅúÊ≠¢ËÉåÊôØÈü≥‰πêÂπ∂ÈáçÁΩÆ
            if (backgroundMusic) {
                backgroundMusic.pause();
                backgroundMusic.currentTime = 0;
            }
            
            // ÈáçÁΩÆÈü≥È¢ëËÆæÁΩÆ
            soundEnabled = true;
            musicEnabled = true;
            musicVolume = 0.1;
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            updateSoundButton();
            updateMusicButton();
            
            // ÈáçÊñ∞ÂàùÂßãÂåñÊ∏∏Êàè
            initGame();
            
            // ÊòæÁ§∫ÈáçÁΩÆÂÆåÊàê‰ø°ÊÅØ
            setTimeout(() => {
                messageDisplay.textContent = `üéâ ÊÅ≠Âñú ${playerName} Êàê‰∏∫Magic Tavern CEOÔºÅÁßâÊâøMT‰ª∑ÂÄºËßÇÔºåÊ∏∏ÊàèÂ∑≤ÈáçÁΩÆÔºåÂáÜÂ§áÂºÄÂßãÊñ∞ÁöÑÂÜíÈô©ÔºÅ`;
                setTimeout(() => {
                    messageDisplay.textContent = 'Ê¨¢ËøéÊù•Âà∞ÊãØÊïëZack - MTÂ§ßÂÜíÈô©ÔºÅÁÇπÂáªÂºÄÂßãÊ∏∏ÊàèÔºÅ';
                }, 3000);
            }, 500);
        }

        // ÂàõÂª∫ÁÉüËä±ÊïàÊûú
        function createFireworks(container) {
            const colors = ['#FFD700', '#FF6B35', '#FF1744', '#00E676', '#2196F3', '#9C27B0'];
            
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'firework';
                    firework.style.left = Math.random() * 100 + '%';
                    firework.style.top = Math.random() * 100 + '%';
                    firework.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    firework.style.animationDelay = Math.random() * 2 + 's';
                    container.appendChild(firework);
                    
                    // ÁßªÈô§ÁÉüËä±ÂÖÉÁ¥†
                    setTimeout(() => {
                        if (firework.parentNode) {
                            firework.parentNode.removeChild(firework);
                        }
                    }, 2000);
                }, i * 200);
            }
        }

        // ÂàõÂª∫ÂΩ©Â∏¶ÊïàÊûú
        function createConfetti(container) {
            const colors = ['#FFD700', '#FF6B35', '#FF1744', '#00E676', '#2196F3', '#9C27B0'];
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 3 + 's';
                    confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                    container.appendChild(confetti);
                    
                    // ÁßªÈô§ÂΩ©Â∏¶ÂÖÉÁ¥†
                    setTimeout(() => {
                        if (confetti.parentNode) {
                            confetti.parentNode.removeChild(confetti);
                        }
                    }, 5000);
                }, i * 100);
            }
        }

        // ÂàùÂßãÂåñÈü≥È¢ë‰∏ä‰∏ãÊñá
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                // ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÈü≥ÊïàËÆæÁΩÆ
                const savedSoundSetting = localStorage.getItem('wizardGame_soundEnabled');
                if (savedSoundSetting !== null) {
                    soundEnabled = savedSoundSetting === 'true';
                }
                updateSoundButton();
                
                // ÂàùÂßãÂåñËÉåÊôØÈü≥‰πê
                initBackgroundMusic();
            } catch (e) {
                console.log('Èü≥È¢ë‰∏çÊîØÊåÅ:', e);
                soundEnabled = false;
                updateSoundButton();
            }
        }

        // ÂàùÂßãÂåñËÉåÊôØÈü≥‰πê
        function initBackgroundMusic() {
            try {
                // Â∞ùËØïÂ§öÁßçÂèØËÉΩÁöÑÊñá‰ª∂Âêç
                const possiblePaths = [
                    'background_music.wav',
                    'backgroud_music.wav', // Áî®Êà∑ÊèêÂà∞ÁöÑÂéüÂßãÂêçÁß∞ÔºàÂèØËÉΩÊúâÊãºÂÜôÈîôËØØÔºâ
                    './background_music.wav',
                    './backgroud_music.wav'
                ];
                
                backgroundMusic = new Audio();
                backgroundMusic.loop = true; // Âæ™ÁéØÊí≠Êîæ
                backgroundMusic.volume = musicVolume;
                
                // ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÈü≥‰πêËÆæÁΩÆ
                const savedMusicSetting = localStorage.getItem('wizardGame_musicEnabled');
                const savedMusicVolume = localStorage.getItem('wizardGame_musicVolume');
                
                if (savedMusicSetting !== null) {
                    musicEnabled = savedMusicSetting === 'true';
                }
                // Âõ∫ÂÆöÈü≥Èáè‰∏∫10%Ôºå‰∏ç‰ªéÊú¨Âú∞Â≠òÂÇ®ËØªÂèñ
                musicVolume = 0.1;
                backgroundMusic.volume = musicVolume;
                
                // Ê∑ªÂä†Èü≥È¢ë‰∫ã‰ª∂ÁõëÂê¨Âô®
                backgroundMusic.addEventListener('loadstart', () => {
                    console.log('ÂºÄÂßãÂä†ËΩΩËÉåÊôØÈü≥‰πê...');
                });
                
                backgroundMusic.addEventListener('canplaythrough', () => {
                    console.log('ËÉåÊôØÈü≥‰πêÂä†ËΩΩÂÆåÊàêÔºåÂèØ‰ª•Êí≠Êîæ');
                    updateMusicButton();
                    if (musicEnabled && !firstInteraction) {
                        playBackgroundMusic();
                    }
                });
                
                backgroundMusic.addEventListener('error', (e) => {
                    console.log('ËÉåÊôØÈü≥‰πêÂä†ËΩΩÂ§±Ë¥•:', e);
                    console.log('ÂΩìÂâçÂ∞ùËØïÁöÑÊñá‰ª∂Ë∑ØÂæÑ:', backgroundMusic.src);
                    // Â∞ùËØï‰∏ã‰∏Ä‰∏™Êñá‰ª∂Ë∑ØÂæÑ
                    tryNextMusicPath();
                });
                
                backgroundMusic.addEventListener('play', () => {
                    console.log('ËÉåÊôØÈü≥‰πêÂºÄÂßãÊí≠Êîæ');
                });
                
                backgroundMusic.addEventListener('pause', () => {
                    console.log('ËÉåÊôØÈü≥‰πêÊöÇÂÅú');
                });
                
                // ÂºÄÂßãÂ∞ùËØïÂä†ËΩΩÁ¨¨‰∏Ä‰∏™Ë∑ØÂæÑ
                let currentPathIndex = 0;
                
                function tryNextMusicPath() {
                    if (currentPathIndex < possiblePaths.length) {
                        const path = possiblePaths[currentPathIndex];
                        console.log('Â∞ùËØïÂä†ËΩΩÈü≥‰πêÊñá‰ª∂:', path);
                        backgroundMusic.src = path;
                        backgroundMusic.load();
                        currentPathIndex++;
                    } else {
                        console.log('ÊâÄÊúâÈü≥‰πêÊñá‰ª∂Ë∑ØÂæÑÈÉΩÂ∞ùËØïÂ§±Ë¥•');
                        musicEnabled = false;
                        updateMusicButton();

                    }
                }
                
                // ÂºÄÂßãÂ∞ùËØïÁ¨¨‰∏Ä‰∏™Ë∑ØÂæÑ
                tryNextMusicPath();
                
                updateMusicButton();
                
            } catch (e) {
                console.log('ËÉåÊôØÈü≥‰πêÂàùÂßãÂåñÂ§±Ë¥•:', e);
                musicEnabled = false;
                updateMusicButton();
            }
        }

        // Êí≠ÊîæËÉåÊôØÈü≥‰πê
        function playBackgroundMusic() {
            if (backgroundMusic && musicEnabled) {
                console.log('Â∞ùËØïÊí≠ÊîæËÉåÊôØÈü≥‰πê, Èü≥Èáè:', backgroundMusic.volume);
                console.log('Èü≥‰πêÊñá‰ª∂Áä∂ÊÄÅ:', {
                    src: backgroundMusic.src,
                    readyState: backgroundMusic.readyState,
                    paused: backgroundMusic.paused,
                    currentTime: backgroundMusic.currentTime,
                    duration: backgroundMusic.duration
                });
                
                backgroundMusic.play().then(() => {
                    console.log('ËÉåÊôØÈü≥‰πêÊí≠ÊîæÊàêÂäü');
                }).catch(e => {
                    console.log('ËÉåÊôØÈü≥‰πêÊí≠ÊîæÂ§±Ë¥•:', e);
                    if (e.name === 'NotAllowedError') {
                        console.log('ÊµèËßàÂô®ÈòªÊ≠¢‰∫ÜËá™Âä®Êí≠ÊîæÔºåÈúÄË¶ÅÁî®Êà∑‰∫§‰∫í');

                    }
                });
            } else {
                console.log('Êí≠ÊîæÊù°‰ª∂‰∏çÊª°Ë∂≥:', {
                    hasBackgroundMusic: !!backgroundMusic,
                    musicEnabled: musicEnabled
                });
            }
        }

        // ÊöÇÂÅúËÉåÊôØÈü≥‰πê
        function pauseBackgroundMusic() {
            if (backgroundMusic) {
                backgroundMusic.pause();
            }
        }

        // ÂàáÊç¢ËÉåÊôØÈü≥‰πêÂºÄÂÖ≥
        function toggleMusic() {
            musicEnabled = !musicEnabled;
            localStorage.setItem('wizardGame_musicEnabled', musicEnabled);
            
            if (musicEnabled) {
                console.log('Áî®Êà∑ÊâãÂä®ÂêØÁî®ËÉåÊôØÈü≥‰πê');
                playBackgroundMusic();
            } else {
                console.log('Áî®Êà∑ÊâãÂä®Á¶ÅÁî®ËÉåÊôØÈü≥‰πê');
                pauseBackgroundMusic();
            }
            
            updateMusicButton();
        }



        // ÂàáÊç¢Èü≥ÊïàÂºÄÂÖ≥
        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('wizardGame_soundEnabled', soundEnabled);
            updateSoundButton();
            
            // Êí≠ÊîæÊµãËØïÈü≥Êïà
            if (soundEnabled) {
                playClickSound();
            }
        }

        // Êõ¥Êñ∞Èü≥ÊïàÊåâÈíÆÊòæÁ§∫
        function updateSoundButton() {
            if (soundToggleBtn) {
                soundToggleBtn.textContent = soundEnabled ? 'üîä Èü≥Êïà' : 'üîá Èü≥Êïà';
                soundToggleBtn.style.opacity = soundEnabled ? '1' : '0.6';
            }
        }

        // Êõ¥Êñ∞ËÉåÊôØÈü≥‰πêÊåâÈíÆÊòæÁ§∫
        function updateMusicButton() {
            if (musicToggleBtn) {
                musicToggleBtn.textContent = musicEnabled ? 'üéµ Èü≥‰πê' : 'üîá Èü≥‰πê';
                musicToggleBtn.style.opacity = musicEnabled ? '1' : '0.6';
            }
        }

        // ÊòæÁ§∫ÊéíË°åÊ¶ú
        async function showLeaderboard() {
            try {
                // ‰ΩøÁî®ÂêéÁ´ØÊúçÂä°Âô®Âú∞ÂùÄ
                const apiUrl = window.location.hostname === 'localhost' 
                    ? '/api/leaderboard?limit=10'
                    : 'https://rebirth-gyuv.onrender.com/api/leaderboard?limit=10';
                const response = await fetch(apiUrl);
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Ëé∑ÂèñÊéíË°åÊ¶úÂ§±Ë¥•');
                }
                
                const leaderboard = result.data.leaderboard || [];
                
                const overlay = document.createElement('div');
                overlay.className = 'leaderboard-overlay';
                
                let leaderboardHTML = '';
                if (leaderboard.length === 0) {
                    leaderboardHTML = '<div class="leaderboard-empty">üéÆ ÊöÇÊó†ÈÄöÂÖ≥ËÆ∞ÂΩï<br/>Êàê‰∏∫Á¨¨‰∏Ä‰∏™ÈÄöÂÖ≥ÁöÑÂãáÂ£´ÂêßÔºÅ</div>';
                } else {
                    leaderboardHTML = '<div class="leaderboard-list">';
                    leaderboard.forEach((player, index) => {
                        const rank = index + 1;
                        const rankClass = rank <= 3 ? `rank-${rank}` : '';
                        const rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
                        
                        leaderboardHTML += `
                            <div class="leaderboard-item ${rankClass}">
                                <div class="leaderboard-rank ${rankClass}">${rankEmoji}${rank}</div>
                                <div class="leaderboard-name">${player.playerName}</div>
                                <div class="leaderboard-deaths">üíÄ ${player.totalDeaths}</div>
                            </div>
                        `;
                    });
                    leaderboardHTML += '</div>';
                }
                
                overlay.innerHTML = `
                    <div class="leaderboard-box">
                        <div class="leaderboard-title">
                            üèÜ ÈÄöÂÖ≥ÊéíË°åÊ¶ú
                        </div>
                        ${leaderboardHTML}
                        <button class="leaderboard-close-btn">ÂÖ≥Èó≠</button>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                const closeBtn = overlay.querySelector('.leaderboard-close-btn');
                closeBtn.addEventListener('click', () => {
                    document.body.removeChild(overlay);
                });
                
                // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                    }
                });
                
            } catch (error) {
                console.error('Ëé∑ÂèñÊéíË°åÊ¶úÂ§±Ë¥•:', error);
                showDialog('Ëé∑ÂèñÊéíË°åÊ¶úÂ§±Ë¥•', 'Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®ÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ');
            }
        }



        // ÁîüÊàêÁàÜÁÇ∏Èü≥Êïà
        function playExplosionSound() {
            if (!soundEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // ÁàÜÁÇ∏Èü≥ÊïàÔºö‰ΩéÈ¢ëÂô™Èü≥
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(150, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.5);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        // ÁîüÊàêËøáÂÖ≥Èü≥Êïà
        function playSuccessSound() {
            if (!soundEnabled || !audioContext) return;
            
            // Êí≠Êîæ‰∏ÄÁ≥ªÂàó‰∏äÂçáÁöÑÈü≥Á¨¶
            const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
            
            notes.forEach((frequency, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime + index * 0.15);
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime + index * 0.15);
                gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + index * 0.15 + 0.05);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + index * 0.15 + 0.3);
                
                oscillator.start(audioContext.currentTime + index * 0.15);
                oscillator.stop(audioContext.currentTime + index * 0.15 + 0.3);
            });
        }

        // ÁîüÊàêÊåâÈîÆÈü≥Êïà
        function playClickSound() {
            if (!soundEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.1);
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.1);
        }
        
        // ÈîÆÁõòÁä∂ÊÄÅËøΩË∏™
        const keys = {
            ArrowUp: false,
            ArrowDown: false,
            ArrowLeft: false,
            ArrowRight: false
        };

        // Êõ¥Êñ∞ËøõÂ∫¶ÊòæÁ§∫
        function updateProgressDisplay() {
            maxLevelDisplay.textContent = gameState.maxUnlockedLevel;
            unlockedLevelsDisplay.textContent = gameState.maxUnlockedLevel;
            loopCountDisplay.textContent = loopCount;
        }

        // ÂàõÂª∫ÂÖ≥Âç°ÈÄâÊã©ÊåâÈíÆ
        function createLevelButtons() {
            levelButtonsContainer.innerHTML = '';
            
            for (let i = 1; i <= gameState.maxLevel; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = 'level-btn';
                
                if (i <= gameState.maxUnlockedLevel) {
                    if (i === gameState.currentLevel) {
                        btn.className += ' current';
                    } else {
                        btn.className += ' unlocked';
                    }
                    btn.onclick = () => selectLevel(i);
                } else {
                    btn.className += ' locked';
                    btn.disabled = true;
                }
                
                levelButtonsContainer.appendChild(btn);
            }
        }

        // ÈÄâÊã©ÂÖ≥Âç°
        function selectLevel(level) {
            if (level <= gameState.maxUnlockedLevel) {
                playClickSound();
                gameState.currentLevel = level;
                saveProgress();
                levelSelectModal.classList.add('hidden');
                startLevel();
            }
        }

        // ÂºÄÂßãÂÖ≥Âç°
        function startLevel() {
            // ËøΩË∏™Ê∏∏ÊàèÂºÄÂßãÁªüËÆ°ÔºàÂÆåÂÖ®ÈùôÈªòÔºå‰∏çÂΩ±ÂìçÊ∏∏ÊàèÔºâ
            gameStats.trackGameStart();
            
            gameState.gameOver = false;
            gameState.player = { x: 50, y: 250 };
            gameState.traps = [];
            gameState.movingTraps = [];
            gameState.specialTraps = [];
            gameState.keys = [];
            gameState.collectedKeys = 0;
            gameState.requiredKeys = 0;
            gameState.playerFrozen = false;
            gameState.freezeEndTime = 0;
            
            messageDisplay.textContent = '';
            nextBtn.classList.add('hidden');
            
            // Ê∏ÖÈô§Áé©ÂÆ∂ÁöÑÁâπÊÆäÁä∂ÊÄÅ
            player.style.filter = '';
            player.style.transform = '';
            
            // Ê∏ÖÈô§‰πãÂâçÁöÑÊâÄÊúâÈô∑Èò±ÔºàÂåÖÊã¨ÁâπÊÆäÈô∑Èò±ÔºâÂíåÈí•Âåô
            document.querySelectorAll('.trap, .spike, .moving-trap, .invisible-trap, .teleport-trap, .hunter-trap, .blink-trap, .gravity-trap, .split-trap, .mirror-trap, .freeze-trap, .bounce-trap, .shrink-trap, .speed-trap, .clone-trap, .player-clone, .key').forEach(el => el.remove());
            
            updatePlayerPosition();
            setupLevel();
            updateProgressDisplay();
        }

        // ÂàùÂßãÂåñÊ∏∏Êàè
        function initGame() {
            // ÂàùÂßãÂåñÈü≥È¢ëÁ≥ªÁªü
            initAudio();
            
            // ÂàùÂßãÂåñÁªüËÆ°Á≥ªÁªüÔºàÂÆåÂÖ®ÈùôÈªòÔºå‰∏çÂΩ±ÂìçÊ∏∏ÊàèÔºâ
            gameStats.init();
            
            // Êõ¥Êñ∞Ê∏∏ÊàèÂå∫ÂüüÂ∞∫ÂØ∏
            updateGameDimensions();
            
            // Âä†ËΩΩ‰øùÂ≠òÁöÑËøõÂ∫¶
            loadProgress();
            
            gameState.gameOver = false;
            gameState.player = { x: 50, y: 250 };
            gameState.traps = [];
            gameState.movingTraps = [];
            gameState.specialTraps = [];
            gameState.keys = [];
            gameState.collectedKeys = 0;
            gameState.requiredKeys = 0;
            gameState.playerFrozen = false;
            gameState.freezeEndTime = 0;
            
            messageDisplay.textContent = '';
            nextBtn.classList.add('hidden');
            
            // Á°Æ‰øùÂÖ≥Âç°ÈÄâÊã©Âô®ÊòØÈöêËóèÁöÑ
            levelSelectModal.classList.add('hidden');
            
            // Ê∏ÖÈô§Áé©ÂÆ∂ÁöÑÁâπÊÆäÁä∂ÊÄÅ
            player.style.filter = '';
            player.style.transform = '';
            
            // Ê∏ÖÈô§‰πãÂâçÁöÑÊâÄÊúâÈô∑Èò±ÔºàÂåÖÊã¨ÁâπÊÆäÈô∑Èò±ÔºâÂíåÈí•Âåô
            document.querySelectorAll('.trap, .spike, .moving-trap, .invisible-trap, .teleport-trap, .hunter-trap, .blink-trap, .gravity-trap, .split-trap, .mirror-trap, .freeze-trap, .bounce-trap, .shrink-trap, .speed-trap, .clone-trap, .player-clone, .key').forEach(el => el.remove());
            
            updatePlayerPosition();
            setupLevel();
            updateProgressDisplay();
        }

        // ËÆæÁΩÆÂΩìÂâçÂÖ≥Âç°
        function setupLevel() {
            levelDisplay.textContent = gameState.currentLevel;
            
            // Êõ¥Êñ∞‰ΩçÁΩÆÊòæÁ§∫
            locationDisplay.textContent = levelLocations[gameState.currentLevel] || "Êú™Áü•Âå∫Âüü";
            
            // Ê†πÊçÆÂÖ≥Âç°Ë∞ÉÊï¥Áé©ÂÆ∂ÁßªÂä®ÈÄüÂ∫¶ÔºàÈ´òÂÖ≥Âç°Á®çÂæÆÂø´‰∏ÄÁÇπ‰ª•Â∫îÂØπÊõ¥Â§öÈô∑Èò±Ôºâ
            playerSpeed = basePlayerSpeed + Math.floor(gameState.currentLevel / 3); // ÊØè3ÂÖ≥Â¢ûÂä†1ÁÇπÈÄüÂ∫¶
            
            // Á¨¨10ÂÖ≥ÊøÄÊ¥ªÂú∞Áã±Ê®°Âºè
            if (gameState.currentLevel === 10) {
                gameContainer.classList.add('hell-mode');
                // Á¨¨10ÂÖ≥Áé©ÂÆ∂ÈÄüÂ∫¶Á®çÂæÆÊèêÂçá‰ª•Â∫îÂØπË∂ÖÈ´òÈöæÂ∫¶
                playerSpeed = basePlayerSpeed + 4;
            } else {
                gameContainer.classList.remove('hell-mode');
            }
            
            // Ê†πÊçÆÂÖ≥Âç°ËÆæÁΩÆÈô∑Èò±ÔºàÁîüÊàêÊñ∞Â∏ÉÂ±ÄÔºâ
            createTraps(false);
            
            // ËÆæÁΩÆÁßªÂä®Èô∑Èò±ÔºàÁîüÊàêÊñ∞Â∏ÉÂ±ÄÔºâ
            setupMovingTraps(false);
            
            // ÂàõÂª∫Èí•ÂåôÔºà‰ªÖÂú®Á¨¨3„ÄÅ4„ÄÅ5ÂÖ≥Ôºâ
            createKeys();
            
            // ËøΩË∏™ÂÖ≥Âç°ÂºÄÂßãÁªüËÆ°ÔºàÂÆåÂÖ®ÈùôÈªòÔºå‰∏çÂΩ±ÂìçÊ∏∏ÊàèÔºâ
            gameStats.trackLevelAttempt(gameState.currentLevel, loopCount);
            
            // ÊòæÁ§∫ÂΩìÂâçÂÖ≥Âç°ÁöÑÂØπËØùÊ°Ü
            const currentDialog = levelDialogs[gameState.currentLevel];
            if (currentDialog) {
                const content = typeof currentDialog.content === 'function' 
                    ? currentDialog.content() 
                    : currentDialog.content;
                showDialog(currentDialog.title, content);
            }
        }

        // ÁîüÊàêÂÖ≥Âç°Â∏ÉÂ±ÄÁßçÂ≠ê
        function generateLevelSeed(level) {
            return level * 12345; // ‰ΩøÁî®ÂÖ≥Âç°Êï∞ÁîüÊàêÂõ∫ÂÆöÁßçÂ≠ê
        }
        
        // Âü∫‰∫éÁßçÂ≠êÁöÑÈöèÊú∫Êï∞ÁîüÊàêÂô®
        function seededRandom(seed) {
            const x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }

        // ÂàõÂª∫ÁâπÊÆäÈô∑Èò±
        function createSpecialTrap(trap, seed, seedCounter, sizeMultiplier) {
            const specialTypes = ['invisible', 'teleport', 'hunter', 'blink', 'gravity', 'split', 'mirror', 'freeze', 'bounce', 'shrink', 'speed', 'clone'];
            const typeIndex = Math.floor(seededRandom(seed + seedCounter++) * specialTypes.length);
            const trapType = specialTypes[typeIndex];
            
            const result = createSpecificTrap(trap, trapType, seed, seedCounter, sizeMultiplier);
            return {
                seedCounter: result,
                trapType: trapType
            };
        }
        
        // ÂàõÂª∫ÊåáÂÆöÁ±ªÂûãÁöÑÁâπÊÆäÈô∑Èò±
        function createSpecificTrap(trap, trapType, seed, seedCounter, sizeMultiplier) {
            const baseSize = 40;
            const width = baseSize * sizeMultiplier;
            const height = baseSize * sizeMultiplier;
            
            // ÁîüÊàêÂÆâÂÖ®‰ΩçÁΩÆÔºåÈÅøÂÖç‰∏éÂÖ∂‰ªñÂÖÉÁ¥†ÂÜ≤Á™Å
            const position = generateSafePosition(width, height, seed, seedCounter);
            seedCounter = position.seedCounter;
            
            switch(trapType) {
                case 'invisible':
                    trap.className = 'invisible-trap';
                    trap.dataset.trapType = 'invisible';
                    trap.dataset.revealed = 'false';
                    break;
                case 'teleport':
                    trap.className = 'teleport-trap';
                    trap.dataset.trapType = 'teleport';
                    break;
                case 'hunter':
                    trap.className = 'hunter-trap';
                    trap.dataset.trapType = 'hunter';
                    trap.dataset.huntSpeed = '2';
                    break;
                case 'blink':
                    trap.className = 'blink-trap';
                    trap.dataset.trapType = 'blink';
                    trap.dataset.visible = 'true';
                    break;
                case 'gravity':
                    trap.className = 'gravity-trap';
                    trap.dataset.trapType = 'gravity';
                    trap.dataset.pullForce = '3';
                    break;
                case 'split':
                    trap.className = 'split-trap';
                    trap.dataset.trapType = 'split';
                    trap.dataset.hasTriggered = 'false';
                    break;
                case 'mirror':
                    trap.className = 'mirror-trap';
                    trap.dataset.trapType = 'mirror';
                    break;
                case 'freeze':
                    trap.className = 'freeze-trap';
                    trap.dataset.trapType = 'freeze';
                    break;
                case 'bounce':
                    trap.className = 'bounce-trap';
                    trap.dataset.trapType = 'bounce';
                    break;
                case 'shrink':
                    trap.className = 'shrink-trap';
                    trap.dataset.trapType = 'shrink';
                    break;
                case 'speed':
                    trap.className = 'speed-trap';
                    trap.dataset.trapType = 'speed';
                    break;
                case 'clone':
                    trap.className = 'clone-trap';
                    trap.dataset.trapType = 'clone';
                    trap.dataset.hasTriggered = 'false';
                    break;
            }
            
            trap.style.width = width + 'px';
            trap.style.height = height + 'px';
            trap.style.left = position.x + 'px';
            trap.style.bottom = (gameHeight - position.y - height) + 'px';
            
            // ‰øùÂ≠òÁâπÊÆäÈô∑Èò±‰ø°ÊÅØ
            gameState.levelLayouts[gameState.currentLevel].staticTraps.push({
                className: trap.className,
                trapType: trapType,
                width: width,
                height: height,
                left: position.x,
                bottom: (gameHeight - position.y - height),
                data: {...trap.dataset}
            });
            
            return seedCounter;
        }
        
        // ÂàõÂª∫ÈùôÊÄÅÈô∑Èò±
        function createTraps(useExistingLayout = false) {
            // Á¨¨‰∏ÄÂÖ≥Ê≤°Êúâ‰ªª‰ΩïÈô∑Èò±
            if (gameState.currentLevel === 1) {
                return;
            }
            
            // Â¶ÇÊûúË¶ÅÈáçÁî®Áé∞ÊúâÂ∏ÉÂ±Ä
            if (useExistingLayout && gameState.levelLayouts[gameState.currentLevel]) {
                const layout = gameState.levelLayouts[gameState.currentLevel];
                
                // ÈáçÂª∫ÈùôÊÄÅÈô∑Èò±
                for (const trapData of layout.staticTraps) {
                    const trap = document.createElement('div');
                    trap.className = trapData.className;
                    
                    if (trapData.trapType) {
                        // ÈáçÂª∫ÁâπÊÆäÈô∑Èò±
                        trap.dataset.trapType = trapData.trapType;
                        if (trapData.data) {
                            Object.assign(trap.dataset, trapData.data);
                        }
                        trap.style.width = trapData.width + 'px';
                        trap.style.height = trapData.height + 'px';
                        trap.style.left = trapData.left + 'px';
                        trap.style.bottom = trapData.bottom + 'px';
                    } else if (trapData.className === 'trap') {
                        trap.style.width = trapData.width + 'px';
                        trap.style.height = trapData.height + 'px';
                        trap.style.left = trapData.left + 'px';
                        trap.style.bottom = trapData.bottom + 'px';
                    } else {
                        trap.style.left = trapData.left + 'px';
                    }
                    
                    gameContainer.appendChild(trap);
                    gameState.traps.push(trap);
                }
                return;
            }
            
            // ÁîüÊàêÊñ∞ÁöÑÂ∏ÉÂ±Ä
            const seed = generateLevelSeed(gameState.currentLevel);
            let seedCounter = 0;
            
            // ‰ºòÂåñÁöÑÂÖ≥Âç°ÈöæÂ∫¶Êõ≤Á∫ø - Ê∏êËøõÂºèÊåëÊàò
            let trapCount;
            if (gameState.currentLevel === 1) {
                trapCount = 0; // Á¨¨1ÂÖ≥ÔºöÊñ∞ÊâãÂèãÂ•ΩÔºåÊó†Èô∑Èò±
            } else if (gameState.currentLevel <= 3) {
                trapCount = (gameState.currentLevel - 1) * 3; // Á¨¨2-3ÂÖ≥Ôºö3,6‰∏™Èô∑Èò±
            } else if (gameState.currentLevel <= 6) {
                trapCount = 6 + (gameState.currentLevel - 3) * 4; // Á¨¨4-6ÂÖ≥Ôºö10,14,18‰∏™Èô∑Èò±
            } else if (gameState.currentLevel <= 8) {
                trapCount = 18 + (gameState.currentLevel - 6) * 5; // Á¨¨7-8ÂÖ≥Ôºö23,28‰∏™Èô∑Èò±
            } else if (gameState.currentLevel === 9) {
                trapCount = 34; // Á¨¨9ÂÖ≥Ôºö34‰∏™Èô∑Èò±
            } else {
                trapCount = 40; // Á¨¨10ÂÖ≥Ôºö40‰∏™Èô∑Èò± (ÈÄÇÂ∫¶ÊåëÊàò)
            }
            
            // ÂàùÂßãÂåñÂÖ≥Âç°Â∏ÉÂ±ÄÂ≠òÂÇ®
            if (!gameState.levelLayouts[gameState.currentLevel]) {
                gameState.levelLayouts[gameState.currentLevel] = {
                    staticTraps: [],
                    movingTraps: []
                };
            }
            
            // ÂÖàÁ°Æ‰øùÊØèÂÖ≥Ëá≥Â∞ëÊúâË∂≥Â§üÁöÑÈöêÂΩ¢Èô∑Èò±Ôºà‰ªéÁ¨¨2ÂÖ≥ÂºÄÂßãÔºâ
            let invisibleTrapCount = 0;
            const minInvisibleTraps = gameState.currentLevel >= 2 ? (gameState.currentLevel === 10 ? 6 : 3) : 0;
            
            for (let i = 0; i < trapCount; i++) {
                const trap = document.createElement('div');
                
                // ÈáçÊñ∞Ë∞ÉÊï¥Èô∑Èò±Á±ªÂûãÊØî‰æãÔºåËÆ©Ê∏∏ÊàèÊõ¥ÊúâË∂£ (ÈÄÇÈÖç10ÂÖ≥)
                const specialChance = gameState.currentLevel === 10 ? 0.55 : Math.min(0.1 + gameState.currentLevel * 0.05, 0.6); // Á¨¨10ÂÖ≥ÁâπÊÆäÈô∑Èò±ÊØî‰æã55%
                const spikeChance = gameState.currentLevel === 10 ? 0.25 : Math.min(0.2 + gameState.currentLevel * 0.05, 0.6); // Á¨¨10ÂÖ≥Â∞ñÂà∫ÊØî‰æã25%
                const trapChance = gameState.currentLevel === 10 ? 0.15 : 0.3; // Á¨¨10ÂÖ≥ÊñπÂùóÈô∑Èò±ÊØî‰æã15%
                const randomValue = seededRandom(seed + seedCounter++);
                
                // È´òÂÖ≥Âç°ÁöÑÈô∑Èò±Êõ¥Â§ß
                const sizeMultiplier = gameState.currentLevel === 10 ? 1.2 : (1 + gameState.currentLevel * 0.02); // Á¨¨10ÂÖ≥Èô∑Èò±Â∞∫ÂØ∏1.2ÂÄç
                
                // Â¶ÇÊûúËøòÊ≤°ÊúâË∂≥Â§üÁöÑÈöêÂΩ¢Èô∑Èò±ÔºåÂº∫Âà∂ÂàõÂª∫ÈöêÂΩ¢Èô∑Èò±
                if (invisibleTrapCount < minInvisibleTraps && (i >= trapCount - (minInvisibleTraps - invisibleTrapCount) || randomValue < 0.3)) {
                    seedCounter = createSpecificTrap(trap, 'invisible', seed, seedCounter, sizeMultiplier);
                    invisibleTrapCount++;
                } else if (randomValue < specialChance && gameState.currentLevel >= 2) {
                    // ÂàõÂª∫ÁâπÊÆäÈô∑Èò±Ôºà‰ªéÁ¨¨2ÂÖ≥ÂºÄÂßãÔºåÊõ¥Êó©Âá∫Áé∞Ôºâ
                    const createdType = createSpecialTrap(trap, seed, seedCounter, sizeMultiplier);
                    seedCounter = createdType.seedCounter;
                    if (createdType.trapType === 'invisible') {
                        invisibleTrapCount++;
                    }
                } else if (randomValue < specialChance + spikeChance) {
                    // Â∞ñÂà∫Èô∑Èò±Ôºà‰ºòÂÖàÁ∫ßÊèêÈ´òÔºâ
                    trap.className = 'spike';
                    
                    // ÁîüÊàêÂÆâÂÖ®‰ΩçÁΩÆÔºåÈÅøÂÖç‰∏éÂÖ∂‰ªñÂÖÉÁ¥†ÂÜ≤Á™Å
                    const position = generateSafePosition(30, 40, seed, seedCounter);
                    seedCounter = position.seedCounter;
                    
                    trap.style.left = position.x + 'px';
                    
                    // ‰øùÂ≠òÂ∏ÉÂ±Ä‰ø°ÊÅØ
                    gameState.levelLayouts[gameState.currentLevel].staticTraps.push({
                        className: 'spike',
                        left: position.x
                    });
                } else if (randomValue < specialChance + spikeChance + trapChance) {
                    // Áü©ÂΩ¢Èô∑Èò±
                    trap.className = 'trap';
                    const width = (30 + seededRandom(seed + seedCounter++) * 70) * sizeMultiplier;
                    const height = (20 + seededRandom(seed + seedCounter++) * 50) * sizeMultiplier;
                    const finalWidth = Math.min(width, 120);
                    const finalHeight = Math.min(height, 80);
                    
                    // ÁîüÊàêÂÆâÂÖ®‰ΩçÁΩÆÔºåÈÅøÂÖç‰∏éÂÖ∂‰ªñÂÖÉÁ¥†ÂÜ≤Á™Å
                    const position = generateSafePosition(finalWidth, finalHeight, seed, seedCounter);
                    seedCounter = position.seedCounter;
                    
                    trap.style.width = finalWidth + 'px';
                    trap.style.height = finalHeight + 'px';
                    trap.style.left = position.x + 'px';
                    trap.style.bottom = (gameHeight - position.y - finalHeight) + 'px';
                    
                    // ‰øùÂ≠òÂ∏ÉÂ±Ä‰ø°ÊÅØ
                    gameState.levelLayouts[gameState.currentLevel].staticTraps.push({
                        className: 'trap',
                        width: finalWidth,
                        height: finalHeight,
                        left: position.x,
                        bottom: (gameHeight - position.y - finalHeight)
                    });
                } else {
                    // Â¶ÇÊûúÈÉΩ‰∏çÊª°Ë∂≥ÔºåÂàõÂª∫‰∏Ä‰∏™Â∞ñÂà∫Èô∑Èò±‰Ωú‰∏∫ÈªòËÆ§
                    trap.className = 'spike';
                    
                    // ÁîüÊàêÂÆâÂÖ®‰ΩçÁΩÆÔºåÈÅøÂÖç‰∏éÂÖ∂‰ªñÂÖÉÁ¥†ÂÜ≤Á™Å
                    const position = generateSafePosition(30, 40, seed, seedCounter);
                    seedCounter = position.seedCounter;
                    
                    trap.style.left = position.x + 'px';
                    
                    // ‰øùÂ≠òÂ∏ÉÂ±Ä‰ø°ÊÅØ
                    gameState.levelLayouts[gameState.currentLevel].staticTraps.push({
                        className: 'spike',
                        left: position.x
                    });
                }
                
                gameContainer.appendChild(trap);
                gameState.traps.push(trap);
            }
        }

        // ËÆæÁΩÆÁßªÂä®Èô∑Èò±
        function setupMovingTraps(useExistingLayout = false) {
            // Á¨¨1-3ÂÖ≥Ê≤°ÊúâÁßªÂä®Èô∑Èò±
            if (gameState.currentLevel <= 3) {
                return;
            }
            
            // Â¶ÇÊûúË¶ÅÈáçÁî®Áé∞ÊúâÂ∏ÉÂ±Ä
            if (useExistingLayout && gameState.levelLayouts[gameState.currentLevel]) {
                const layout = gameState.levelLayouts[gameState.currentLevel];
                
                // ÈáçÂª∫ÁßªÂä®Èô∑Èò±
                for (const trapData of layout.movingTraps) {
                    const movingTrap = document.createElement('div');
                    movingTrap.className = 'moving-trap';
                    
                    movingTrap.style.left = trapData.startX + 'px';
                    movingTrap.style.top = trapData.startY + 'px';
                    
                    gameContainer.appendChild(movingTrap);
                    gameState.movingTraps.push({
                        element: movingTrap,
                        x: trapData.startX,
                        y: trapData.startY,
                        speedX: trapData.speedX,
                        speedY: trapData.speedY
                    });
                }
                
                // ÂºÄÂßãÁßªÂä®Èô∑Èò±
                if (trapInterval) clearInterval(trapInterval);
                const updateInterval = Math.max(15, 35 - gameState.currentLevel * 0.2);
                trapInterval = setInterval(moveTraps, updateInterval);
                return;
            }
            
            // ÁîüÊàêÊñ∞ÁöÑÁßªÂä®Èô∑Èò±Â∏ÉÂ±Ä
            const seed = generateLevelSeed(gameState.currentLevel);
            let seedCounter = 1000; // ‰ΩøÁî®‰∏çÂêåÁöÑËµ∑ÂßãÂÄºÈÅøÂÖç‰∏éÈùôÊÄÅÈô∑Èò±ÂÜ≤Á™Å
            
            // ‰ºòÂåñÁöÑÁßªÂä®Èô∑Èò±ÈöæÂ∫¶Êõ≤Á∫ø
            let movingTrapCount;
            if (gameState.currentLevel <= 3) {
                movingTrapCount = 0; // Á¨¨1-3ÂÖ≥ÔºöÊó†ÁßªÂä®Èô∑Èò±Ôºå‰∏ìÊ≥®Â≠¶‰π†Âü∫Á°Ä
            } else if (gameState.currentLevel <= 5) {
                movingTrapCount = gameState.currentLevel - 3; // Á¨¨4-5ÂÖ≥Ôºö1,2‰∏™ÁßªÂä®Èô∑Èò±
            } else if (gameState.currentLevel <= 7) {
                movingTrapCount = 2 + (gameState.currentLevel - 5); // Á¨¨6-7ÂÖ≥Ôºö3,4‰∏™ÁßªÂä®Èô∑Èò±
            } else if (gameState.currentLevel <= 9) {
                movingTrapCount = 4 + (gameState.currentLevel - 7) * 2; // Á¨¨8-9ÂÖ≥Ôºö6,8‰∏™ÁßªÂä®Èô∑Èò±
            } else {
                movingTrapCount = 12; // Á¨¨10ÂÖ≥Ôºö12‰∏™ÁßªÂä®Èô∑Èò± (ÈÄÇÂ∫¶Âä®ÊÄÅÊåëÊàò)
            }
            
            for (let i = 0; i < movingTrapCount; i++) {
                const movingTrap = document.createElement('div');
                movingTrap.className = 'moving-trap';
                
                // ÁîüÊàêÂÆâÂÖ®ÁöÑÂàùÂßã‰ΩçÁΩÆÔºåÈÅøÂÖç‰∏éÂÖ∂‰ªñÂÖÉÁ¥†ÂÜ≤Á™Å
                const position = generateSafePosition(40, 40, seed, seedCounter);
                seedCounter = position.seedCounter;
                const startX = position.x;
                const startY = position.y;
                
                // Ê†πÊçÆÂÖ≥Âç°Ë∞ÉÊï¥ÁßªÂä®ÈÄüÂ∫¶
                const baseSpeed = gameState.currentLevel === 10 ? 3 : (2 + gameState.currentLevel * 0.05); // Á¨¨10ÂÖ≥Âü∫Á°ÄÈÄüÂ∫¶3
                const maxSpeed = gameState.currentLevel === 10 ? 6 : Math.min(baseSpeed, 8); // Á¨¨10ÂÖ≥ÊúÄÂ§ßÈÄüÂ∫¶6
                const speedX = (seededRandom(seed + seedCounter++) - 0.5) * maxSpeed;
                const speedY = (seededRandom(seed + seedCounter++) - 0.5) * maxSpeed;
                
                movingTrap.style.left = startX + 'px';
                movingTrap.style.top = startY + 'px';
                
                gameContainer.appendChild(movingTrap);
                gameState.movingTraps.push({
                    element: movingTrap,
                    x: startX,
                    y: startY,
                    speedX: speedX,
                    speedY: speedY
                });
                
                // ‰øùÂ≠òÁßªÂä®Èô∑Èò±Â∏ÉÂ±Ä‰ø°ÊÅØ
                gameState.levelLayouts[gameState.currentLevel].movingTraps.push({
                    startX: startX,
                    startY: startY,
                    speedX: speedX,
                    speedY: speedY
                });
            }
            
            // ÂºÄÂßãÁßªÂä®Èô∑Èò±ÔºåÈ´òÂÖ≥Âç°Êõ¥Êñ∞È¢ëÁéáÊõ¥È´ò
            if (trapInterval) clearInterval(trapInterval);
            const updateInterval = gameState.currentLevel === 10 ? 18 : Math.max(15, 35 - gameState.currentLevel * 0.2); // Á¨¨10ÂÖ≥18msÊõ¥Êñ∞Èó¥Èöî
            trapInterval = setInterval(moveTraps, updateInterval);
        }

        // ÁßªÂä®Èô∑Èò±
        function moveTraps() {
            gameState.movingTraps.forEach(trap => {
                trap.x += trap.speedX;
                trap.y += trap.speedY;
                
                // ËæπÁïåÊ£ÄÊµã
                if (trap.x <= 0 || trap.x >= gameWidth - 40) {
                    trap.speedX *= -1;
                }
                if (trap.y <= 0 || trap.y >= gameHeight - 40) {
                    trap.speedY *= -1;
                }
                
                trap.element.style.left = trap.x + 'px';
                trap.element.style.top = trap.y + 'px';
            });
        }

        // Êõ¥Êñ∞Áé©ÂÆ∂‰ΩçÁΩÆ
        function updatePlayerPosition() {
            player.style.left = gameState.player.x + 'px';
            player.style.top = gameState.player.y + 'px';
        }
        
        // Ê£ÄÊü•‰ΩçÁΩÆÊòØÂê¶‰∏éÁé∞ÊúâÂÖÉÁ¥†ÂÜ≤Á™Å
        function isPositionOccupied(x, y, width, height, buffer = 20) {
            const newRect = {
                left: x - buffer,
                right: x + width + buffer,
                top: y - buffer,
                bottom: y + height + buffer
            };
            
            // Ê£ÄÊü•‰∏éÂá∫Âè£ÁöÑË∑ùÁ¶ªÔºàÁ°Æ‰øùÂá∫Âè£Âë®Âõ¥ÊúâË∂≥Â§üÁ©∫Èó¥Ôºâ
            const doorRect = {
                left: gameWidth - 80 - 40, // Âá∫Âè£Â∑¶ËæπÁïå - È¢ùÂ§ñÁºìÂÜ≤
                right: gameWidth - 20 + 40, // Âá∫Âè£Âè≥ËæπÁïå + È¢ùÂ§ñÁºìÂÜ≤
                top: gameHeight - 100 - 40, // Âá∫Âè£È°∂ÈÉ® - È¢ùÂ§ñÁºìÂÜ≤
                bottom: gameHeight + 40 // Âá∫Âè£Â∫ïÈÉ® + È¢ùÂ§ñÁºìÂÜ≤
            };
            
            if (newRect.right > doorRect.left && newRect.left < doorRect.right &&
                newRect.bottom > doorRect.top && newRect.top < doorRect.bottom) {
                return true; // ‰∏éÂá∫Âè£Âå∫ÂüüÂÜ≤Á™Å
            }
            
            // Ê£ÄÊü•‰∏éËµ∑Âßã‰ΩçÁΩÆÁöÑË∑ùÁ¶ªÔºàÁ°Æ‰øùÁé©ÂÆ∂Ëµ∑Âßã‰ΩçÁΩÆÂÆâÂÖ®Ôºâ
            const startRect = {
                left: 50 - 60,
                right: 50 + 40 + 60,
                top: 250 - 60,
                bottom: 250 + 50 + 60
            };
            
            if (newRect.right > startRect.left && newRect.left < startRect.right &&
                newRect.bottom > startRect.top && newRect.top < startRect.bottom) {
                return true; // ‰∏éËµ∑Âßã‰ΩçÁΩÆÂÜ≤Á™Å
            }
            
            // Ê£ÄÊü•‰∏éÁé∞ÊúâÈô∑Èò±ÁöÑÂÜ≤Á™ÅÔºàÂåÖÊã¨DOM‰∏≠ÁöÑÂíåÂ∏ÉÂ±ÄÊï∞ÊçÆ‰∏≠ÁöÑÔºâ
            for (const trap of gameState.traps) {
                if (trap.parentNode) { // Âè™Ê£ÄÊü•Â∑≤Ê∑ªÂä†Âà∞DOMÁöÑÈô∑Èò±
                    const trapRect = trap.getBoundingClientRect();
                    const containerRect = gameContainer.getBoundingClientRect();
                    const trapX = trapRect.left - containerRect.left;
                    const trapY = trapRect.top - containerRect.top;
                    const trapWidth = trapRect.width || 40;
                    const trapHeight = trapRect.height || 40;
                    
                    const existingRect = {
                        left: trapX - buffer,
                        right: trapX + trapWidth + buffer,
                        top: trapY - buffer,
                        bottom: trapY + trapHeight + buffer
                    };
                    
                    if (newRect.right > existingRect.left && newRect.left < existingRect.right &&
                        newRect.bottom > existingRect.top && newRect.top < existingRect.bottom) {
                        return true; // ‰∏éÁé∞ÊúâÈô∑Èò±ÂÜ≤Á™Å
                    }
                }
            }
            
            // Ê£ÄÊü•‰∏éÂ∏ÉÂ±ÄÊï∞ÊçÆ‰∏≠Â∑≤ËßÑÂàíÁöÑÈô∑Èò±‰ΩçÁΩÆÂÜ≤Á™Å
            if (gameState.levelLayouts[gameState.currentLevel]) {
                for (const trapData of gameState.levelLayouts[gameState.currentLevel].staticTraps) {
                    const trapX = trapData.left;
                    const trapY = trapData.bottom ? gameHeight - trapData.bottom - (trapData.height || 40) : 0;
                    const trapWidth = trapData.width || 40;
                    const trapHeight = trapData.height || 40;
                    
                    const existingRect = {
                        left: trapX - buffer,
                        right: trapX + trapWidth + buffer,
                        top: trapY - buffer,
                        bottom: trapY + trapHeight + buffer
                    };
                    
                    if (newRect.right > existingRect.left && newRect.left < existingRect.right &&
                        newRect.bottom > existingRect.top && newRect.top < existingRect.bottom) {
                        return true; // ‰∏éËßÑÂàíÁöÑÈô∑Èò±‰ΩçÁΩÆÂÜ≤Á™Å
                    }
                }
            }
            
            // Ê£ÄÊü•‰∏éÁé∞ÊúâÈí•ÂåôÁöÑÂÜ≤Á™Å
            for (const key of gameState.keys) {
                if (key.parentNode) { // Âè™Ê£ÄÊü•Â∑≤Ê∑ªÂä†Âà∞DOMÁöÑÈí•Âåô
                    const keyRect = key.getBoundingClientRect();
                    const containerRect = gameContainer.getBoundingClientRect();
                    const keyX = keyRect.left - containerRect.left;
                    const keyY = keyRect.top - containerRect.top;
                    const keyWidth = keyRect.width || 30;
                    const keyHeight = keyRect.height || 30;
                    
                    const existingRect = {
                        left: keyX - buffer,
                        right: keyX + keyWidth + buffer,
                        top: keyY - buffer,
                        bottom: keyY + keyHeight + buffer
                    };
                    
                    if (newRect.right > existingRect.left && newRect.left < existingRect.right &&
                        newRect.bottom > existingRect.top && newRect.top < existingRect.bottom) {
                        return true; // ‰∏éÁé∞ÊúâÈí•ÂåôÂÜ≤Á™Å
                    }
                }
            }
            
            return false; // ‰ΩçÁΩÆÂèØÁî®
        }
        
        // ÁîüÊàêÂÆâÂÖ®‰ΩçÁΩÆ
        function generateSafePosition(width, height, seed, seedCounter, maxAttempts = 50) {
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
                const x = 100 + seededRandom(seed + seedCounter + attempt * 2) * (gameWidth - 200 - width);
                const y = 50 + seededRandom(seed + seedCounter + attempt * 2 + 1) * (gameHeight - 100 - height);
                
                if (!isPositionOccupied(x, y, width, height)) {
                    return { x, y, seedCounter: seedCounter + attempt * 2 + 2 };
                }
            }
            
            // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂÆâÂÖ®‰ΩçÁΩÆÔºåËøîÂõû‰∏Ä‰∏™Áõ∏ÂØπÂÆâÂÖ®ÁöÑÈªòËÆ§‰ΩçÁΩÆ
            const fallbackX = 150 + (seedCounter % 3) * 200;
            const fallbackY = 100 + (seedCounter % 2) * 200;
            return { x: fallbackX, y: fallbackY, seedCounter: seedCounter + maxAttempts * 2 };
        }

        // ÂàõÂª∫Èí•Âåô
        function createKeys() {
            // Âè™Âú®Á¨¨3„ÄÅ4„ÄÅ5ÂÖ≥ÁîüÊàêÈí•Âåô
            if (gameState.currentLevel < 3 || gameState.currentLevel > 5) {
                gameState.requiredKeys = 0;
                keyInfoDisplay.style.display = 'none';
                return;
            }
            
            // Á°Æ‰øùÊ∏∏ÊàèÂ∞∫ÂØ∏ÊòØÊúÄÊñ∞ÁöÑ
            updateGameDimensions();
            
            gameState.requiredKeys = 3;
            gameState.collectedKeys = 0;
            gameState.keys = [];
            keyInfoDisplay.style.display = 'inline';
            updateKeyDisplay();
            
            const seed = generateLevelSeed(gameState.currentLevel);
            let seedCounter = 5000; // ‰ΩøÁî®‰∏çÂêåÁöÑËµ∑ÂßãÂÄºÈÅøÂÖç‰∏éÈô∑Èò±ÂÜ≤Á™Å
            
            // Á≠âÂæÖ‰∏ÄÂ∞èÊÆµÊó∂Èó¥Á°Æ‰øùÊâÄÊúâÈô∑Èò±ÈÉΩÂ∑≤ÁªèÊ∑ªÂä†Âà∞DOM
            setTimeout(() => {
                console.log('ÂºÄÂßãÁîüÊàêÈí•ÂåôÔºåÈúÄË¶ÅÁîüÊàê3Êää');
                
                // Ê†πÊçÆÂΩìÂâçÊ∏∏ÊàèÂå∫ÂüüÂ§ßÂ∞èÂä®ÊÄÅËÆ°ÁÆóÈí•Âåô‰ΩçÁΩÆ
                const keyPositions = [
                    { x: Math.min(150, gameWidth * 0.2), y: Math.min(100, gameHeight * 0.3) },
                    { x: Math.min(300, gameWidth * 0.4), y: Math.min(150, gameHeight * 0.4) },
                    { x: Math.min(450, gameWidth * 0.6), y: Math.min(200, gameHeight * 0.5) }
                ];
                
                for (let i = 0; i < 3; i++) {
                    const key = document.createElement('div');
                    key.className = 'key';
                    key.innerHTML = 'üóùÔ∏è';
                    
                    // È¶ñÂÖàÂ∞ùËØïÁîüÊàêÂÆâÂÖ®‰ΩçÁΩÆ
                    let position = generateSafePositionForKey(30, 30, seed, seedCounter + i * 1000, i);
                    
                    // Â¶ÇÊûúÁîüÊàêÁöÑ‰ΩçÁΩÆ‰∏éÂ∑≤ÊúâÈí•ÂåôÈáçÂè†Ôºå‰ΩøÁî®È¢ÑÂÆö‰πâ‰ΩçÁΩÆ
                    const existingKeys = gameState.keys;
                    let positionConflict = false;
                    for (const existingKey of existingKeys) {
                        const existingX = parseInt(existingKey.style.left);
                        const existingY = parseInt(existingKey.style.top);
                        if (Math.abs(position.x - existingX) < 60 && Math.abs(position.y - existingY) < 60) {
                            positionConflict = true;
                            break;
                        }
                    }
                    
                    if (positionConflict) {
                        position = keyPositions[i];
                        console.log(`Èí•Âåô${i + 1}‰ΩçÁΩÆÂÜ≤Á™ÅÔºå‰ΩøÁî®È¢ÑÂÆö‰πâ‰ΩçÁΩÆ: (${position.x}, ${position.y})`);
                    }
                    
                    seedCounter = position.seedCounter || seedCounter + 100;
                    
                    key.style.left = position.x + 'px';
                    key.style.top = position.y + 'px';
                    
                    console.log(`ÁîüÊàêÁ¨¨${i + 1}ÊääÈí•ÂåôÔºå‰ΩçÁΩÆ: (${position.x}, ${position.y})`);
                    
                    // ‰∏çÈúÄË¶ÅÁÇπÂáª‰∫ã‰ª∂ÔºåÈÄöËøáÁ¢∞ÊíûÊ£ÄÊµãÊî∂ÈõÜ
                    
                    gameContainer.appendChild(key);
                    gameState.keys.push(key);
                }
                console.log(`Èí•ÂåôÁîüÊàêÂÆåÊàêÔºåÊÄªÂÖ±ÁîüÊàê‰∫Ü${gameState.keys.length}ÊääÈí•Âåô`);
            }, 100); // Âª∂Ëøü100msÁ°Æ‰øùÈô∑Èò±ÈÉΩÂ∑≤ÂàõÂª∫ÂÆåÊàê
        }
        
        // ‰∏ìÈó®‰∏∫Èí•ÂåôÁîüÊàêÂÆâÂÖ®‰ΩçÁΩÆÁöÑÂáΩÊï∞Ôºå‰ΩøÁî®Êõ¥‰∏•Ê†ºÁöÑÊ£ÄÊü•
        function generateSafePositionForKey(width, height, seed, seedCounter, keyIndex = 0, maxAttempts = 100) {
            // Á°Æ‰øùÈí•ÂåôÁîüÊàêÂú®ÂèØËßÜÂå∫ÂüüÂÜÖÔºåÊ†πÊçÆÂ±èÂπïÂ§ßÂ∞èÂä®ÊÄÅË∞ÉÊï¥ËæπÁïå
            const minX = Math.max(50, gameWidth * 0.1);
            const maxX = Math.min(gameWidth - 100, gameWidth * 0.85) - width;
            const minY = Math.max(30, gameHeight * 0.15);
            const maxY = Math.min(gameHeight - 80, gameHeight * 0.8) - height;
            
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
                const x = minX + seededRandom(seed + seedCounter + attempt * 2) * (maxX - minX);
                const y = minY + seededRandom(seed + seedCounter + attempt * 2 + 1) * (maxY - minY);
                
                if (isPositionSafeForKey(x, y, width, height)) {
                    return { x, y, seedCounter: seedCounter + attempt * 2 + 2 };
                }
            }
            
            // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂÆâÂÖ®‰ΩçÁΩÆÔºå‰ΩøÁî®È¢ÑÂÆö‰πâÁöÑÂÆâÂÖ®Âå∫ÂüüÔºàÊ†πÊçÆÂ±èÂπïÂ§ßÂ∞èÂä®ÊÄÅË∞ÉÊï¥Ôºâ
            const safeZones = [
                { x: Math.max(120, gameWidth * 0.15), y: Math.max(80, gameHeight * 0.25) },
                { x: Math.min(gameWidth - 200, gameWidth * 0.7), y: Math.max(80, gameHeight * 0.25) },
                { x: Math.max(120, gameWidth * 0.15), y: Math.min(gameHeight - 150, gameHeight * 0.6) },
                { x: gameWidth / 2 - 15, y: Math.max(80, gameHeight * 0.25) },
                { x: gameWidth / 2 - 15, y: Math.min(gameHeight - 150, gameHeight * 0.6) },
                { x: Math.min(200, gameWidth * 0.25), y: Math.max(120, gameHeight * 0.35) },
                { x: Math.min(300, gameWidth * 0.4), y: Math.max(120, gameHeight * 0.35) },
                { x: Math.min(400, gameWidth * 0.55), y: Math.max(120, gameHeight * 0.35) }
            ];
            
            for (const zone of safeZones) {
                if (isPositionSafeForKey(zone.x, zone.y, width, height)) {
                    console.log(`‰ΩøÁî®È¢ÑÂÆö‰πâÂÆâÂÖ®Âå∫Âüü: (${zone.x}, ${zone.y})`);
                    return { x: zone.x, y: zone.y, seedCounter: seedCounter + maxAttempts * 2 };
                }
            }
            
            // ÊúÄÂêéÁöÑÂ§áÈÄâ‰ΩçÁΩÆ - Âº∫Âà∂ÁîüÊàêÔºå‰∏çÂÜçÊ£ÄÊü•ÂÜ≤Á™Å
            // ‰ΩøÁî®Èí•ÂåôÁ¥¢ÂºïÁ°Æ‰øùÊØèÊääÈí•ÂåôÊúâ‰∏çÂêå‰ΩçÁΩÆÔºàÊ†πÊçÆÂ±èÂπïÂ§ßÂ∞èÂä®ÊÄÅË∞ÉÊï¥Ôºâ
            const fallbackPositions = [
                { x: Math.min(150, gameWidth * 0.2), y: Math.min(100, gameHeight * 0.3) },
                { x: Math.min(300, gameWidth * 0.4), y: Math.min(150, gameHeight * 0.4) },
                { x: Math.min(450, gameWidth * 0.6), y: Math.min(200, gameHeight * 0.5) },
                { x: Math.min(200, gameWidth * 0.3), y: Math.min(300, gameHeight * 0.7) },
                { x: Math.min(350, gameWidth * 0.5), y: Math.min(320, gameHeight * 0.75) }
            ];
            
            const selectedPosition = fallbackPositions[keyIndex % fallbackPositions.length];
            console.log(`‰ΩøÁî®Âº∫Âà∂Â§áÈÄâ‰ΩçÁΩÆ ${keyIndex}: (${selectedPosition.x}, ${selectedPosition.y})`);
            return { x: selectedPosition.x, y: selectedPosition.y, seedCounter: seedCounter + maxAttempts * 2 };
        }
        
        // Ê£ÄÊü•‰ΩçÁΩÆÂØπÈí•ÂåôÊòØÂê¶ÂÆâÂÖ®ÔºàÊõ¥‰∏•Ê†ºÁöÑÊ£ÄÊü•Ôºâ
        function isPositionSafeForKey(x, y, width, height, buffer = 35) {
            const newRect = {
                left: x - buffer,
                right: x + width + buffer,
                top: y - buffer,
                bottom: y + height + buffer
            };
            
            // Ê£ÄÊü•‰∏éÂá∫Âè£ÁöÑË∑ùÁ¶ªÔºàÁ°Æ‰øùÂá∫Âè£Âë®Âõ¥ÊúâË∂≥Â§üÁ©∫Èó¥Ôºâ
            const doorRect = {
                left: gameWidth - 80 - 60, // Âá∫Âè£Â∑¶ËæπÁïå - Êõ¥Â§ßÁºìÂÜ≤
                right: gameWidth - 20 + 60, // Âá∫Âè£Âè≥ËæπÁïå + Êõ¥Â§ßÁºìÂÜ≤
                top: gameHeight - 100 - 60, // Âá∫Âè£È°∂ÈÉ® - Êõ¥Â§ßÁºìÂÜ≤
                bottom: gameHeight + 60 // Âá∫Âè£Â∫ïÈÉ® + Êõ¥Â§ßÁºìÂÜ≤
            };
            
            if (newRect.right > doorRect.left && newRect.left < doorRect.right &&
                newRect.bottom > doorRect.top && newRect.top < doorRect.bottom) {
                return false; // ‰∏éÂá∫Âè£Âå∫ÂüüÂÜ≤Á™Å
            }
            
            // Ê£ÄÊü•‰∏éËµ∑Âßã‰ΩçÁΩÆÁöÑË∑ùÁ¶ªÔºàÁ°Æ‰øùÁé©ÂÆ∂Ëµ∑Âßã‰ΩçÁΩÆÂÆâÂÖ®Ôºâ
            const startRect = {
                left: 50 - 80,
                right: 50 + 40 + 80,
                top: 250 - 80,
                bottom: 250 + 50 + 80
            };
            
            if (newRect.right > startRect.left && newRect.left < startRect.right &&
                newRect.bottom > startRect.top && newRect.top < startRect.bottom) {
                return false; // ‰∏éËµ∑Âßã‰ΩçÁΩÆÂÜ≤Á™Å
            }
            
            // Ê£ÄÊü•‰∏éÊâÄÊúâDOM‰∏≠ÁöÑÈô∑Èò±ÁöÑÂÜ≤Á™Å
            const allTraps = gameContainer.querySelectorAll('.trap, .spike, .moving-trap, .invisible-trap, .teleport-trap, .hunter-trap, .blink-trap, .gravity-trap, .split-trap, .mirror-trap, .freeze-trap, .bounce-trap, .shrink-trap, .speed-trap, .clone-trap');
            
            for (const trap of allTraps) {
                const trapRect = trap.getBoundingClientRect();
                const containerRect = gameContainer.getBoundingClientRect();
                const trapX = trapRect.left - containerRect.left;
                const trapY = trapRect.top - containerRect.top;
                const trapWidth = trapRect.width || 40;
                const trapHeight = trapRect.height || 40;
                
                const existingRect = {
                    left: trapX - buffer,
                    right: trapX + trapWidth + buffer,
                    top: trapY - buffer,
                    bottom: trapY + trapHeight + buffer
                };
                
                if (newRect.right > existingRect.left && newRect.left < existingRect.right &&
                    newRect.bottom > existingRect.top && newRect.top < existingRect.bottom) {
                    return false; // ‰∏éÁé∞ÊúâÈô∑Èò±ÂÜ≤Á™Å
                }
            }
            
            // Ê£ÄÊü•‰∏éÁßªÂä®Èô∑Èò±ÁöÑÂÜ≤Á™Å
            for (const movingTrap of gameState.movingTraps) {
                const trapX = movingTrap.x;
                const trapY = movingTrap.y;
                const trapWidth = 40;
                const trapHeight = 40;
                
                const existingRect = {
                    left: trapX - buffer,
                    right: trapX + trapWidth + buffer,
                    top: trapY - buffer,
                    bottom: trapY + trapHeight + buffer
                };
                
                if (newRect.right > existingRect.left && newRect.left < existingRect.right &&
                    newRect.bottom > existingRect.top && newRect.top < existingRect.bottom) {
                    return false; // ‰∏éÁßªÂä®Èô∑Èò±ÂÜ≤Á™Å
                }
            }
            
            return true; // ‰ΩçÁΩÆÂÆâÂÖ®
        }
        
        // Êî∂ÈõÜÈí•Âåô
        function collectKey(keyElement) {
            if (gameState.gameOver) return;
            
            // Êí≠ÊîæÊî∂ÈõÜÈü≥Êïà
            playClickSound();
            
            // ËøΩË∏™Èí•ÂåôÊî∂ÈõÜÁªüËÆ°ÔºàÂÆåÂÖ®ÈùôÈªòÔºå‰∏çÂΩ±ÂìçÊ∏∏ÊàèÔºâ
            gameStats.trackKeyCollected();
            
            // ÁßªÈô§Èí•Âåô
            keyElement.remove();
            gameState.keys = gameState.keys.filter(k => k !== keyElement);
            gameState.collectedKeys++;
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            updateKeyDisplay();
            
            // ÊòæÁ§∫Êî∂ÈõÜÊèêÁ§∫
            messageDisplay.textContent = `üóùÔ∏è Êî∂ÈõÜÂà∞Èí•ÂåôÔºÅ(${gameState.collectedKeys}/${gameState.requiredKeys})`;
            setTimeout(() => {
                if (messageDisplay.textContent.includes('Êî∂ÈõÜÂà∞Èí•Âåô')) {
                    messageDisplay.textContent = '';
                }
            }, 1500);
            
            // Ê£ÄÊü•ÊòØÂê¶Êî∂ÈõÜÂÆåÊØï
            if (gameState.collectedKeys >= gameState.requiredKeys) {
                messageDisplay.textContent = '‚ú® ÊâÄÊúâÈí•ÂåôÊî∂ÈõÜÂÆåÊØïÔºÅÁé∞Âú®ÂèØ‰ª•ËøõÂÖ•‰∏ã‰∏ÄÂÖ≥‰∫ÜÔºÅ';
                setTimeout(() => {
                    if (messageDisplay.textContent.includes('ÊâÄÊúâÈí•ÂåôÊî∂ÈõÜÂÆåÊØï')) {
                        messageDisplay.textContent = '';
                    }
                }, 3000);
            }
        }
        
        // Êõ¥Êñ∞Èí•ÂåôÊòæÁ§∫
        function updateKeyDisplay() {
            if (gameState.requiredKeys > 0) {
                keyCountDisplay.textContent = `${gameState.collectedKeys}/${gameState.requiredKeys}`;
            }
        }
        
        // Ê£ÄÊü•Èí•ÂåôÊî∂ÈõÜÊù°‰ª∂
        function checkKeyRequirement() {
            // Âè™Âú®Á¨¨3„ÄÅ4„ÄÅ5ÂÖ≥Ê£ÄÊü•Èí•Âåô
            if (gameState.currentLevel >= 3 && gameState.currentLevel <= 5) {
                return gameState.collectedKeys >= gameState.requiredKeys;
            }
            return true; // ÂÖ∂‰ªñÂÖ≥Âç°‰∏çÈúÄË¶ÅÈí•Âåô
        }

        // Â§ÑÁêÜÁâπÊÆäÈô∑Èò±
        function handleSpecialTrap(trap) {
            const trapType = trap.dataset.trapType;
            
            switch(trapType) {
                case 'teleport':
                    // ‰º†ÈÄÅÈô∑Èò±ÔºöÈöèÊú∫‰º†ÈÄÅÁé©ÂÆ∂
                    playClickSound(); // ‰º†ÈÄÅÈü≥Êïà
                    gameState.player.x = 50 + Math.random() * (gameWidth - 150);
                    gameState.player.y = 50 + Math.random() * (gameHeight - 100);
                    updatePlayerPosition();
                    messageDisplay.textContent = 'üí´ ‰º†ÈÄÅ‰∫ÜÔºÅ';
                    setTimeout(() => {
                        if (messageDisplay.textContent.includes('‰º†ÈÄÅ‰∫Ü')) {
                            messageDisplay.textContent = '';
                        }
                    }, 1500);
                    break;
                    
                case 'freeze':
                    // ÂÜ∞ÂÜªÈô∑Èò±ÔºöÂÜªÁªìÁé©ÂÆ∂3Áßí
                    gameState.playerFrozen = true;
                    gameState.freezeEndTime = Date.now() + 3000;
                    player.style.filter = 'hue-rotate(240deg) brightness(0.7)';
                    messageDisplay.textContent = 'üßä Ë¢´ÂÜ∞ÂÜª‰∫ÜÔºÅ';
                    setTimeout(() => {
                        gameState.playerFrozen = false;
                        player.style.filter = '';
                        if (messageDisplay.textContent.includes('Ë¢´ÂÜ∞ÂÜª‰∫Ü')) {
                            messageDisplay.textContent = '';
                        }
                    }, 3000);
                    break;
                    
                case 'split':
                    // ÂàÜË£ÇÈô∑Èò±ÔºöÂàÜË£ÇÊàê4‰∏™Â∞èÈô∑Èò±
                    if (trap.dataset.hasTriggered === 'false') {
                        trap.dataset.hasTriggered = 'true';
                        createSplitTraps(trap);
                        trap.remove();
                        gameState.traps = gameState.traps.filter(t => t !== trap);
                    }
                    break;
                    
                case 'gravity':
                    // ÈáçÂäõÈô∑Èò±ÔºöÊääÁé©ÂÆ∂ÊãâÂêë‰∏≠ÂøÉÁÑ∂ÂêéÁàÜÁÇ∏
                    const trapRect = trap.getBoundingClientRect();
                    const centerX = trapRect.left + trapRect.width / 2 - gameContainer.getBoundingClientRect().left;
                    const centerY = trapRect.top + trapRect.height / 2 - gameContainer.getBoundingClientRect().top;
                    gameState.player.x = centerX - 20;
                    gameState.player.y = centerY - 25;
                    updatePlayerPosition();
                    setTimeout(() => gameOver(), 500);
                    break;
                    
                case 'bounce':
                    // ÂºπË∑≥Èô∑Èò±ÔºöÊääÁé©ÂÆ∂ÂºπÂà∞ÈöèÊú∫ÊñπÂêë
                    playClickSound();
                    const bounceForce = 100;
                    const angle = Math.random() * 2 * Math.PI;
                    gameState.player.x += Math.cos(angle) * bounceForce;
                    gameState.player.y += Math.sin(angle) * bounceForce;
                    
                    // Á°Æ‰øùÁé©ÂÆ∂‰∏ç‰ºöË¢´ÂºπÂá∫ËæπÁïå
                    gameState.player.x = Math.max(0, Math.min(gameWidth - 40, gameState.player.x));
                    gameState.player.y = Math.max(0, Math.min(gameHeight - 50, gameState.player.y));
                    updatePlayerPosition();
                    
                    messageDisplay.textContent = 'üèÄ Ë¢´ÂºπÈ£û‰∫ÜÔºÅ';
                    setTimeout(() => {
                        if (messageDisplay.textContent.includes('Ë¢´ÂºπÈ£û‰∫Ü')) {
                            messageDisplay.textContent = '';
                        }
                    }, 1500);
                    break;
                    
                case 'shrink':
                    // Áº©Â∞èÈô∑Èò±ÔºöËÆ©Áé©ÂÆ∂ÂèòÂ∞è5Áßí
                    player.style.transform = 'scale(0.5)';
                    messageDisplay.textContent = 'üîç ÂèòÂ∞è‰∫ÜÔºÅ';
                    setTimeout(() => {
                        player.style.transform = '';
                        if (messageDisplay.textContent.includes('ÂèòÂ∞è‰∫Ü')) {
                            messageDisplay.textContent = '';
                        }
                    }, 5000);
                    break;
                    
                case 'speed':
                    // Âä†ÈÄüÈô∑Èò±ÔºöËÆ©Áé©ÂÆ∂ÁßªÂä®ÈÄüÂ∫¶ÁøªÂÄç5Áßí
                    const originalSpeed = playerSpeed;
                    playerSpeed *= 2;
                    player.style.filter = 'hue-rotate(120deg) brightness(1.2)';
                    messageDisplay.textContent = '‚ö° Âä†ÈÄü‰∫ÜÔºÅ';
                    setTimeout(() => {
                        playerSpeed = originalSpeed;
                        player.style.filter = '';
                        if (messageDisplay.textContent.includes('Âä†ÈÄü‰∫Ü')) {
                            messageDisplay.textContent = '';
                        }
                    }, 5000);
                    break;
                    
                case 'clone':
                    // ÂÖãÈöÜÈô∑Èò±ÔºöÂàõÂª∫Áé©ÂÆ∂ÁöÑÈïúÂÉè
                    if (trap.dataset.hasTriggered === 'false') {
                        trap.dataset.hasTriggered = 'true';
                        createPlayerClone();
                        messageDisplay.textContent = 'üë• Âá∫Áé∞‰∫ÜÂàÜË∫´ÔºÅ';
                        setTimeout(() => {
                            if (messageDisplay.textContent.includes('Âá∫Áé∞‰∫ÜÂàÜË∫´')) {
                                messageDisplay.textContent = '';
                            }
                        }, 2000);
                    }
                    break;
                    
                default:
                    // ÂÖ∂‰ªñÁâπÊÆäÈô∑Èò±‰πü‰ºöÂØºËá¥Ê∏∏ÊàèÁªìÊùü
                    gameOver();
                    break;
            }
        }

        // ÂàõÂª∫ÂàÜË£ÇÁöÑÂ∞èÈô∑Èò±
        function createSplitTraps(originalTrap) {
            const rect = originalTrap.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2 - gameContainer.getBoundingClientRect().left;
            const centerY = rect.top + rect.height / 2 - gameContainer.getBoundingClientRect().top;
            
            const directions = [
                {x: -1, y: -1}, {x: 1, y: -1}, 
                {x: -1, y: 1}, {x: 1, y: 1}
            ];
            
            directions.forEach((dir, index) => {
                setTimeout(() => {
                    const smallTrap = document.createElement('div');
                    smallTrap.className = 'trap';
                    smallTrap.style.width = '20px';
                    smallTrap.style.height = '20px';
                    smallTrap.style.left = (centerX + dir.x * 30) + 'px';
                    smallTrap.style.top = (centerY + dir.y * 30) + 'px';
                    smallTrap.style.position = 'absolute';
                    
                    gameContainer.appendChild(smallTrap);
                    gameState.traps.push(smallTrap);
                }, index * 100);
            });
        }

        // ÂàõÂª∫Áé©ÂÆ∂ÂÖãÈöÜ
        function createPlayerClone() {
            const clone = document.createElement('div');
            clone.className = 'player-clone';
            clone.innerHTML = 'üßô‚Äç‚ôÇÔ∏è';
            clone.style.position = 'absolute';
            clone.style.width = '40px';
            clone.style.height = '50px';
            clone.style.fontSize = '40px';
            clone.style.display = 'flex';
            clone.style.alignItems = 'center';
            clone.style.justifyContent = 'center';
            clone.style.zIndex = '3';
            clone.style.opacity = '0.7';
            clone.style.filter = 'hue-rotate(180deg)';
            
            // ÂÖãÈöÜÂá∫Áé∞Âú®Áé©ÂÆ∂ÈôÑËøëÁöÑÈöèÊú∫‰ΩçÁΩÆ
            const offsetX = (Math.random() - 0.5) * 200;
            const offsetY = (Math.random() - 0.5) * 200;
            clone.style.left = Math.max(0, Math.min(gameWidth - 40, gameState.player.x + offsetX)) + 'px';
            clone.style.top = Math.max(0, Math.min(gameHeight - 50, gameState.player.y + offsetY)) + 'px';
            
            gameContainer.appendChild(clone);
            
            // ÂÖãÈöÜ‰ºöË∑üÈöèÁé©ÂÆ∂ÁßªÂä®Ôºå‰ΩÜÊúâÂª∂Ëøü
            let cloneX = parseFloat(clone.style.left);
            let cloneY = parseFloat(clone.style.top);
            
            const cloneInterval = setInterval(() => {
                if (gameState.gameOver) {
                    clearInterval(cloneInterval);
                    clone.remove();
                    return;
                }
                
                // ÂÖãÈöÜÁºìÊÖ¢Ë∑üÈöèÁé©ÂÆ∂
                const dx = gameState.player.x - cloneX;
                const dy = gameState.player.y - cloneY;
                cloneX += dx * 0.1;
                cloneY += dy * 0.1;
                
                clone.style.left = cloneX + 'px';
                clone.style.top = cloneY + 'px';
            }, 50);
            
            // 10ÁßíÂêéÁßªÈô§ÂÖãÈöÜ
            setTimeout(() => {
                clearInterval(cloneInterval);
                if (clone.parentNode) {
                    clone.remove();
                }
            }, 10000);
        }

        // Ê£ÄÊµãÁ¢∞Êíû
        function checkCollisions() {
            const playerRect = player.getBoundingClientRect();
            const doorRect = door.getBoundingClientRect();
            
            // Ê£ÄÊü•ÊòØÂê¶ÂÆåÂÖ®ËøõÂÖ•Èó®ÂÜÖÔºàÁé©ÂÆ∂ÈúÄË¶ÅÂÆåÂÖ®Âú®Èó®ÁöÑËåÉÂõ¥ÂÜÖÔºâ
            if (playerRect.left >= doorRect.left + 5 && 
                playerRect.right <= doorRect.right - 5 && 
                playerRect.bottom >= doorRect.top + 5 && 
                playerRect.top <= doorRect.bottom - 5) {
                levelComplete();
                return;
            }
            
            // Ê£ÄÊü•‰∏éÈùôÊÄÅÈô∑Èò±ÁöÑÁ¢∞Êíû
            for (const trap of gameState.traps) {
                const trapRect = trap.getBoundingClientRect();
                if (playerRect.right > trapRect.left && 
                    playerRect.left < trapRect.right && 
                    playerRect.bottom > trapRect.top && 
                    playerRect.top < trapRect.bottom) {
                    
                    // Â§ÑÁêÜÁâπÊÆäÈô∑Èò±
                    if (trap.dataset.trapType) {
                        // Èó™ÁÉÅÈô∑Èò±Âú®‰∏çÂèØËßÅÊó∂‰∏ç‰ºöÈÄ†Êàê‰º§ÂÆ≥
                        if (trap.dataset.trapType === 'blink' && trap.dataset.visible === 'false') {
                            continue;
                        }
                        handleSpecialTrap(trap);
                    } else {
                        gameOver();
                    }
                    return;
                }
            }
            
            // Ê£ÄÊü•‰∏éÁßªÂä®Èô∑Èò±ÁöÑÁ¢∞Êíû
            for (const trap of gameState.movingTraps) {
                const trapRect = trap.element.getBoundingClientRect();
                if (playerRect.right > trapRect.left && 
                    playerRect.left < trapRect.right && 
                    playerRect.bottom > trapRect.top && 
                    playerRect.top < trapRect.bottom) {
                    gameOver();
                    return;
                }
            }
            
            // Ê£ÄÊü•‰∏éÈí•ÂåôÁöÑÁ¢∞Êíû
            for (let i = gameState.keys.length - 1; i >= 0; i--) {
                const key = gameState.keys[i];
                const keyRect = key.getBoundingClientRect();
                if (playerRect.right > keyRect.left && 
                    playerRect.left < keyRect.right && 
                    playerRect.bottom > keyRect.top && 
                    playerRect.top < keyRect.bottom) {
                    collectKey(key);
                    break; // ‰∏ÄÊ¨°Âè™Êî∂ÈõÜ‰∏ÄÊääÈí•Âåô
                }
            }
            
            // Ê£ÄÊü•ËæπÁïå
            if (gameState.player.x < 0 || gameState.player.x > gameWidth - 40 ||
                gameState.player.y < 0 || gameState.player.y > gameHeight - 50) {
                gameOver();
                return;
            }
        }

        // ÂÖ≥Âç°ÂÆåÊàê
        function levelComplete() {
            // Èò≤Ê≠¢ÈáçÂ§çË∞ÉÁî®
            if (gameState.gameOver) return;
            
            // Ê£ÄÊü•Èí•ÂåôÊî∂ÈõÜÊù°‰ª∂
            if (!checkKeyRequirement()) {
                messageDisplay.textContent = `üóùÔ∏è ËøòÈúÄË¶ÅÊî∂ÈõÜ ${gameState.requiredKeys - gameState.collectedKeys} ÊääÈí•ÂåôÊâçËÉΩËøõÂÖ•‰∏ã‰∏ÄÂÖ≥ÔºÅ`;
                setTimeout(() => {
                    if (messageDisplay.textContent.includes('ËøòÈúÄË¶ÅÊî∂ÈõÜ')) {
                        messageDisplay.textContent = '';
                    }
                }, 3000);
                return;
            }
            
            gameState.gameOver = true;
            
            // Êí≠ÊîæËøáÂÖ≥Èü≥Êïà
            playSuccessSound();
            
            // Ê∑ªÂä†ËøáÂÖ≥ÁâπÊïà
            const sparkle = document.createElement('div');
            sparkle.className = 'level-complete';
            sparkle.style.left = (gameState.player.x - 30) + 'px';
            sparkle.style.top = (gameState.player.y - 25) + 'px';
            gameContainer.appendChild(sparkle);
            
            // ÁßªÈô§ÁâπÊïà
            setTimeout(() => {
                sparkle.remove();
            }, 1000);
            
            // ËÆ∞ÂΩïÂΩìÂâçÂÖ≥Âç°ÁöÑÊ≠ª‰∫°Ê¨°Êï∞
            levelDeaths[gameState.currentLevel] = currentLevelDeaths;
            
            // ËøΩË∏™ÂÖ≥Âç°ÂÆåÊàêÁªüËÆ°ÔºàÂÆåÂÖ®ÈùôÈªòÔºå‰∏çÂΩ±ÂìçÊ∏∏ÊàèÔºâ
            gameStats.trackLevelComplete(gameState.currentLevel, loopCount);
            
            // Ëß£ÈîÅ‰∏ã‰∏ÄÂÖ≥
            if (gameState.currentLevel === gameState.maxUnlockedLevel && gameState.currentLevel < gameState.maxLevel) {
                gameState.maxUnlockedLevel = gameState.currentLevel + 1;
                saveProgress();
            }
            
            if (gameState.currentLevel === gameState.maxLevel) {
                // Á¨¨10ÂÖ≥ÈÄöÂÖ≥ - ÊòæÁ§∫ZackÊãØÊïëÊàêÂäüÂØπËØùÊ°Ü
                setTimeout(() => {
                    showZackSuccessDialog();
                }, 1500); // Á≠âÂæÖÁâπÊïàÂÆåÊàêÂêéÊòæÁ§∫
            } else {
                messageDisplay.textContent = `‚ú® ÊÅ≠ÂñúÈÄöËøáÁ¨¨ ${gameState.currentLevel} ÂÖ≥ÔºÅËß£ÈîÅÁ¨¨ ${gameState.currentLevel + 1} ÂÖ≥ÔºÅ`;
                // 2ÁßíÂêéËá™Âä®ËøõÂÖ•‰∏ã‰∏ÄÂÖ≥
                setTimeout(() => {
                    nextLevel();
                }, 2000);
            }
        }

        // Ê∏∏ÊàèÁªìÊùü
        function gameOver() {
            // Èò≤Ê≠¢ÈáçÂ§çË∞ÉÁî®
            if (gameState.gameOver) return;
            gameState.gameOver = true;
            
            // Â¢ûÂä†Âæ™ÁéØÊ¨°Êï∞
            loopCount++;
            
            // Â¢ûÂä†ÂΩìÂâçÂÖ≥Âç°Ê≠ª‰∫°Ê¨°Êï∞
            currentLevelDeaths++;
            
            updateProgressDisplay(); // Êõ¥Êñ∞ÊòæÁ§∫
            
            // Êí≠ÊîæÁàÜÁÇ∏Èü≥Êïà
            playExplosionSound();
            
            // Ê∑ªÂä†ÁàÜÁÇ∏ÁâπÊïà
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.style.left = (gameState.player.x - 30) + 'px';
            explosion.style.top = (gameState.player.y - 25) + 'px';
            gameContainer.appendChild(explosion);
            
            // ÈöêËóèÁé©ÂÆ∂
            player.style.display = 'none';
            
            messageDisplay.textContent = `üí• ÁàÜÁÇ∏‰∫ÜÔºÅÁ¨¨${loopCount}Ê¨°Âæ™ÁéØÂºÄÂßã...`;
            
            // ÁßªÈô§ÁàÜÁÇ∏ÁâπÊïàÂπ∂ÈáçÊñ∞ÂºÄÂßãÂΩìÂâçÂÖ≥Âç°
            setTimeout(() => {
                explosion.remove();
                player.style.display = 'flex';
                restartCurrentLevel();
            }, 1500);
        }
        
        // ÈáçÊñ∞ÂºÄÂßãÂΩìÂâçÂÖ≥Âç°
        function restartCurrentLevel() {
            gameState.player = { x: 50, y: 250 };
            gameState.traps = [];
            gameState.movingTraps = [];
            gameState.specialTraps = [];
            gameState.keys = [];
            gameState.collectedKeys = 0;
            gameState.requiredKeys = 0;
            gameState.gameOver = false;
            gameState.playerFrozen = false;
            gameState.freezeEndTime = 0;
            
            messageDisplay.textContent = '';
            
            // Ê∏ÖÈô§Áé©ÂÆ∂ÁöÑÁâπÊÆäÁä∂ÊÄÅ
            player.style.filter = '';
            player.style.transform = '';
            
            // Ê∏ÖÈô§‰πãÂâçÁöÑÈô∑Èò±ÔºàÂåÖÊã¨ÁâπÊÆäÈô∑Èò±ÔºâÂíåÈí•Âåô
            document.querySelectorAll('.trap, .spike, .moving-trap, .invisible-trap, .teleport-trap, .hunter-trap, .blink-trap, .gravity-trap, .split-trap, .mirror-trap, .freeze-trap, .bounce-trap, .shrink-trap, .speed-trap, .clone-trap, .player-clone, .key').forEach(el => el.remove());
            
            updatePlayerPosition();
            
            // ÈáçÁî®Áé∞ÊúâÁöÑÂÖ≥Âç°Â∏ÉÂ±Ä
            levelDisplay.textContent = gameState.currentLevel;
            playerSpeed = basePlayerSpeed + Math.floor(gameState.currentLevel / 3); // ÊØè3ÂÖ≥Â¢ûÂä†1ÁÇπÈÄüÂ∫¶
            createTraps(true); // ‰ΩøÁî®Áé∞ÊúâÂ∏ÉÂ±Ä
            setupMovingTraps(true); // ‰ΩøÁî®Áé∞ÊúâÂ∏ÉÂ±Ä
            createKeys(); // ÈáçÊñ∞ÂàõÂª∫Èí•Âåô
            
            // ËøΩË∏™ÂÖ≥Âç°ÈáçËØïÁªüËÆ°ÔºàÂÆåÂÖ®ÈùôÈªòÔºå‰∏çÂΩ±ÂìçÊ∏∏ÊàèÔºâ
            gameStats.trackLevelAttempt(gameState.currentLevel, loopCount);
        }

        // ‰∏ã‰∏ÄÂÖ≥
        function nextLevel() {
            gameState.currentLevel++;
            
            // ÈáçÁΩÆÂΩìÂâçÂÖ≥Âç°Ê≠ª‰∫°Ê¨°Êï∞
            currentLevelDeaths = 0;
            
            saveProgress(); // ‰øùÂ≠òÂΩìÂâçÂÖ≥Âç°ËøõÂ∫¶
            gameState.player = { x: 50, y: 250 };
            gameState.traps = [];
            gameState.movingTraps = [];
            gameState.specialTraps = [];
            gameState.keys = [];
            gameState.collectedKeys = 0;
            gameState.requiredKeys = 0;
            gameState.gameOver = false;  // ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
            gameState.playerFrozen = false;
            gameState.freezeEndTime = 0;
            
            messageDisplay.textContent = '';
            nextBtn.classList.add('hidden');
            
            // Ê∏ÖÈô§Áé©ÂÆ∂ÁöÑÁâπÊÆäÁä∂ÊÄÅ
            player.style.filter = '';
            player.style.transform = '';
            
            // Ê∏ÖÈô§‰πãÂâçÁöÑÈô∑Èò±ÔºàÂåÖÊã¨ÁâπÊÆäÈô∑Èò±ÔºâÂíåÈí•Âåô
            document.querySelectorAll('.trap, .spike, .moving-trap, .invisible-trap, .teleport-trap, .hunter-trap, .blink-trap, .gravity-trap, .split-trap, .mirror-trap, .freeze-trap, .bounce-trap, .shrink-trap, .speed-trap, .clone-trap, .player-clone, .key').forEach(el => el.remove());
            
            updatePlayerPosition();
            setupLevel();
            updateProgressDisplay(); // Êõ¥Êñ∞ËøõÂ∫¶ÊòæÁ§∫
            
            // ‰∏çÈúÄË¶ÅÂÜçÊ¨°Ë∞ÉÁî®gameLoop()ÔºåÂõ†‰∏∫ÂÆÉÂ∑≤ÁªèÂú®ËøêË°å
        }

        // Êõ¥Êñ∞Áé©ÂÆ∂ÁßªÂä®
        function updatePlayerMovement() {
            if (gameState.gameOver || gameState.playerFrozen) return;
            
            // Á¨¨7„ÄÅ8„ÄÅ9ÂÖ≥ÊñπÂêëÈîÆÂèçËΩ¨
            const isReversedLevel = gameState.currentLevel >= 7 && gameState.currentLevel <= 9;
            
            if (keys.ArrowUp) {
                gameState.player.y += isReversedLevel ? playerSpeed : -playerSpeed;
            }
            if (keys.ArrowDown) {
                gameState.player.y += isReversedLevel ? -playerSpeed : playerSpeed;
            }
            if (keys.ArrowLeft) {
                gameState.player.x += isReversedLevel ? playerSpeed : -playerSpeed;
            }
            if (keys.ArrowRight) {
                gameState.player.x += isReversedLevel ? -playerSpeed : playerSpeed;
            }
            
            updatePlayerPosition();
        }

        // Ê∏∏Êàè‰∏ªÂæ™ÁéØ
        function gameLoop() {
            updatePlayerMovement();
            updateSpecialTraps();
            checkCollisions();
            animationFrame = requestAnimationFrame(gameLoop);
        }

        // Êõ¥Êñ∞ÁâπÊÆäÈô∑Èò±ÁöÑË°å‰∏∫
        function updateSpecialTraps() {
            if (gameState.gameOver) return;
            
            gameState.traps.forEach(trap => {
                const trapType = trap.dataset.trapType;
                if (!trapType) return;
                
                const playerRect = player.getBoundingClientRect();
                const trapRect = trap.getBoundingClientRect();
                
                switch(trapType) {
                    case 'invisible':
                        // ÈöêÂΩ¢Èô∑Èò±ÔºöÁé©ÂÆ∂ÈùûÂ∏∏Èù†ËøëÊó∂ÊâçÊòæÁé∞ÔºåËøúÁ¶ªÊó∂ÈáçÊñ∞ÈöêËóè
                        const distance = Math.sqrt(
                            Math.pow(playerRect.left - trapRect.left, 2) + 
                            Math.pow(playerRect.top - trapRect.top, 2)
                        );
                        if (distance < 80) {
                            if (trap.dataset.revealed === 'false') {
                                trap.dataset.revealed = 'true';
                                trap.classList.add('revealed');
                            }
                        } else if (distance > 100) {
                            // Áé©ÂÆ∂ËøúÁ¶ªÊó∂ÈáçÊñ∞ÈöêËóè
                            if (trap.dataset.revealed === 'true') {
                                trap.dataset.revealed = 'false';
                                trap.classList.remove('revealed');
                            }
                        }
                        break;
                        
                    case 'hunter':
                        // ËøΩË∏™Èô∑Èò±ÔºöË∑üÁùÄÁé©ÂÆ∂ÁßªÂä®
                        const speed = parseFloat(trap.dataset.huntSpeed) || 2;
                        const currentLeft = parseFloat(trap.style.left);
                        const currentTop = parseFloat(trap.style.top);
                        
                        const playerX = gameState.player.x + 20; // Áé©ÂÆ∂‰∏≠ÂøÉÁÇπ
                        const playerY = gameState.player.y + 25;
                        const trapX = currentLeft + 20; // Èô∑Èò±‰∏≠ÂøÉÁÇπ
                        const trapY = currentTop + 20;
                        
                        const dx = playerX - trapX;
                        const dy = playerY - trapY;
                        const magnitude = Math.sqrt(dx * dx + dy * dy);
                        
                        if (magnitude > 5) { // ÈÅøÂÖçÊäñÂä®
                            const moveX = (dx / magnitude) * speed;
                            const moveY = (dy / magnitude) * speed;
                            
                            trap.style.left = Math.max(0, Math.min(gameWidth - 40, currentLeft + moveX)) + 'px';
                            trap.style.top = Math.max(0, Math.min(gameHeight - 40, currentTop + moveY)) + 'px';
                        }
                        break;
                        
                    case 'mirror':
                        // ÈïúÂÉèÈô∑Èò±Ôºö‰∏éÁé©ÂÆ∂ÂÅöÁõ∏ÂèçÁßªÂä®
                        const centerX = gameWidth / 2;
                        const centerY = gameHeight / 2;
                        const mirrorX = centerX - (gameState.player.x - centerX);
                        const mirrorY = centerY - (gameState.player.y - centerY);
                        
                        trap.style.left = Math.max(0, Math.min(gameWidth - 40, mirrorX - 20)) + 'px';
                        trap.style.top = Math.max(0, Math.min(gameHeight - 40, mirrorY - 25)) + 'px';
                        break;
                        
                    case 'gravity':
                        // ÈáçÂäõÈô∑Èò±ÔºöÂê∏ÂºïÁé©ÂÆ∂
                        const gravityDistance = Math.sqrt(
                            Math.pow(playerRect.left - trapRect.left, 2) + 
                            Math.pow(playerRect.top - trapRect.top, 2)
                        );
                        
                        if (gravityDistance < 120) { // ÈáçÂäõËåÉÂõ¥
                            const pullForce = parseFloat(trap.dataset.pullForce) || 3;
                            const trapCenterX = trapRect.left + trapRect.width / 2 - gameContainer.getBoundingClientRect().left;
                            const trapCenterY = trapRect.top + trapRect.height / 2 - gameContainer.getBoundingClientRect().top;
                            
                            const pullX = trapCenterX - (gameState.player.x + 20);
                            const pullY = trapCenterY - (gameState.player.y + 25);
                            const pullMagnitude = Math.sqrt(pullX * pullX + pullY * pullY);
                            
                            if (pullMagnitude > 0) {
                                gameState.player.x += (pullX / pullMagnitude) * pullForce * 0.3;
                                gameState.player.y += (pullY / pullMagnitude) * pullForce * 0.3;
                                updatePlayerPosition();
                            }
                        }
                        break;
                        
                    case 'blink':
                        // Èó™ÁÉÅÈô∑Èò±ÈÄªËæëÂ∑≤ÈÄöËøáCSSÂä®ÁîªÂ§ÑÁêÜ
                        const computedStyle = window.getComputedStyle(trap);
                        trap.dataset.visible = computedStyle.opacity > 0.5 ? 'true' : 'false';
                        break;
                }
            });
        }

        // ÈîÆÁõòÊéßÂà∂
        document.addEventListener('keydown', (e) => {
            if (gameState.gameOver) return;
            
            if (e.key in keys) {
                keys[e.key] = true;
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.key in keys) {
                keys[e.key] = false;
            }
        });
        
        // ÁßªÂä®Á´ØËß¶Êë∏ÊéßÂà∂
        function initMobileControls() {
            let isTouching = false;
            let touchStartX = 0;
            let touchStartY = 0;
            let playerStartX = 0;
            let playerStartY = 0;
            let continuousMove = false;
            let lastUpdateTime = 0;
            const updateInterval = 16; // Á∫¶60fpsÁöÑÊõ¥Êñ∞È¢ëÁéá
            
            // Ëß¶Êë∏Ë∑üÈöèÊéßÂà∂ - ËßíËâ≤Ë∑üÈöèÊâãÊåáÁßªÂä®
            gameContainer.addEventListener('touchstart', (e) => {
                if (gameState.gameOver) return;
                e.preventDefault();
                
                const touch = e.touches[0];
                const rect = gameContainer.getBoundingClientRect();
                touchStartX = touch.clientX - rect.left;
                touchStartY = touch.clientY - rect.top;
                
                // ËÆ∞ÂΩïËßíËâ≤ÂºÄÂßã‰ΩçÁΩÆ
                playerStartX = gameState.player.x;
                playerStartY = gameState.player.y;
                
                isTouching = true;
                continuousMove = false;
                
                // ÂÅúÊ≠¢ÊâÄÊúâÈîÆÁõòÁßªÂä®
                keys.ArrowUp = false;
                keys.ArrowDown = false;
                keys.ArrowLeft = false;
                keys.ArrowRight = false;
            }, { passive: false });
            
            gameContainer.addEventListener('touchmove', (e) => {
                if (gameState.gameOver || !isTouching) return;
                e.preventDefault();
                
                const currentTime = Date.now();
                // ÈôêÂà∂Êõ¥Êñ∞È¢ëÁéáÔºåÈÅøÂÖçËøá‰∫éÈ¢ëÁπÅÁöÑËÆ°ÁÆó
                if (currentTime - lastUpdateTime < updateInterval) return;
                lastUpdateTime = currentTime;
                
                const touch = e.touches[0];
                const rect = gameContainer.getBoundingClientRect();
                const currentTouchX = touch.clientX - rect.left;
                const currentTouchY = touch.clientY - rect.top;
                
                // ËÆ°ÁÆóÊâãÊåáÁßªÂä®ÁöÑË∑ùÁ¶ª
                const deltaX = currentTouchX - touchStartX;
                const deltaY = currentTouchY - touchStartY;
                
                // Â¶ÇÊûúÁßªÂä®Ë∑ùÁ¶ªË∂ÖËøáÈòàÂÄºÔºåÊ†áËÆ∞‰∏∫ËøûÁª≠ÁßªÂä®
                if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                    continuousMove = true;
                }
                
                // ËÆ°ÁÆóÊñ∞ÁöÑËßíËâ≤‰ΩçÁΩÆ
                let newX = playerStartX + deltaX;
                let newY = playerStartY + deltaY;
                
                // ËæπÁïåÊ£ÄÊü•
                newX = Math.max(0, Math.min(gameWidth - 40, newX));
                newY = Math.max(0, Math.min(gameHeight - 50, newY));
                
                // Êõ¥Êñ∞ËßíËâ≤‰ΩçÁΩÆ
                gameState.player.x = newX;
                gameState.player.y = newY;
                updatePlayerPosition();
                
            }, { passive: false });
            
            gameContainer.addEventListener('touchend', (e) => {
                e.preventDefault();
                isTouching = false;
                
                // Â¶ÇÊûúÊòØÁü≠Ë∑ùÁ¶ªÁÇπÂáªÔºàÈùûÊãñÊãΩÔºâÔºåÊ£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫ÜÈí•Âåô
                if (!continuousMove) {
                    const touch = e.changedTouches[0];
                    const rect = gameContainer.getBoundingClientRect();
                    const x = touch.clientX - rect.left;
                    const y = touch.clientY - rect.top;
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÁÇπÂáª‰∫ÜÈí•Âåô
                    gameState.keys.forEach(key => {
                        const keyRect = key.getBoundingClientRect();
                        const containerRect = gameContainer.getBoundingClientRect();
                        const keyX = keyRect.left - containerRect.left;
                        const keyY = keyRect.top - containerRect.top;
                        
                        if (x >= keyX && x <= keyX + keyRect.width &&
                            y >= keyY && y <= keyY + keyRect.height) {
                            collectKey(key);
                        }
                    });
                }
                
                continuousMove = false;
            }, { passive: false });
            
            // ËôöÊãüÊåâÈîÆÊéßÂà∂Ôºà‰Ωú‰∏∫Â§áÈÄâÊñπÊ°àÔºâ
            const dpadButtons = document.querySelectorAll('.dpad-btn');
            
            dpadButtons.forEach(btn => {
                const key = btn.dataset.key;
                
                // Ëß¶Êë∏ÂºÄÂßã
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (gameState.gameOver) return;
                    keys[key] = true;
                    playClickSound();
                }, { passive: false });
                
                // Ëß¶Êë∏ÁªìÊùü
                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    keys[key] = false;
                }, { passive: false });
                
                // Ëß¶Êë∏ÂèñÊ∂àÔºàÊâãÊåáÁßªÂá∫ÊåâÈíÆÂå∫ÂüüÔºâ
                btn.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    keys[key] = false;
                }, { passive: false });
                
                // Èº†Ê†á‰∫ã‰ª∂ÔºàÁî®‰∫éÊ°åÈù¢ÊµãËØïÔºâ
                btn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    if (gameState.gameOver) return;
                    keys[key] = true;
                    playClickSound();
                });
                
                btn.addEventListener('mouseup', (e) => {
                    e.preventDefault();
                    keys[key] = false;
                });
                
                btn.addEventListener('mouseleave', (e) => {
                    keys[key] = false;
                });
            });
        }

        // ‰∫ã‰ª∂ÁõëÂê¨
        nextBtn.addEventListener('click', () => {
            playClickSound();
            nextLevel();
        });
        
        restartBtn.addEventListener('click', () => {
            playClickSound();
            startLevel();
        });
        
        levelSelectBtn.addEventListener('click', () => {
            playClickSound();
            createLevelButtons();
            levelSelectModal.classList.remove('hidden');
        });
        
        soundToggleBtn.addEventListener('click', toggleSound);
        
        musicToggleBtn.addEventListener('click', () => {
            playClickSound();
            toggleMusic();
        });
        
        // ÊéíË°åÊ¶úÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        const leaderboardBtn = document.getElementById('leaderboard-btn');
        leaderboardBtn.addEventListener('click', () => {
            playClickSound();
            showLeaderboard();
        });
        
        closeSelectBtn.addEventListener('click', () => {
            playClickSound();
            levelSelectModal.classList.add('hidden');
        });
        
        resetProgressBtn.addEventListener('click', () => {
            playClickSound();
            if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâËøõÂ∫¶ÂêóÔºüËøôÂ∞ÜÂà†Èô§ÊÇ®ÁöÑÊâÄÊúâÊ∏∏ÊàèËÆ∞ÂΩïÂπ∂Âà∑Êñ∞È°µÈù¢ÔºÅ')) {
                resetProgress();
                // Ê∏ÖÁ©∫ÊâÄÊúâÁºìÂ≠òÂπ∂Âº∫Âà∂Âà∑Êñ∞È°µÈù¢
                if ('caches' in window) {
                    caches.keys().then(function(names) {
                        for (let name of names) {
                            caches.delete(name);
                        }
                    });
                }
                // Âº∫Âà∂Âà∑Êñ∞È°µÈù¢ÔºåÊ∏ÖÁ©∫ÊâÄÊúâÁä∂ÊÄÅ
                window.location.reload(true);
            }
        });

        // È°µÈù¢Âä†ËΩΩÊó∂Á´ãÂç≥ÈöêËóèÂÖ≥Âç°ÈÄâÊã©Âô®
        levelSelectModal.classList.add('hidden');
        
        // Â§ÑÁêÜÈ¶ñÊ¨°Áî®Êà∑‰∫§‰∫íÔºàÁî®‰∫éÂêØÂä®ËÉåÊôØÈü≥‰πêÔºâ
        let firstInteraction = true;
        function handleFirstInteraction() {
            if (firstInteraction && musicEnabled && backgroundMusic) {
                playBackgroundMusic();
                firstInteraction = false;
            }
        }

        // ÁõëÂê¨ÂêÑÁßçÁî®Êà∑‰∫§‰∫í‰∫ã‰ª∂
        document.addEventListener('click', handleFirstInteraction);
        document.addEventListener('keydown', handleFirstInteraction);
        document.addEventListener('touchstart', handleFirstInteraction);
        
        // Á™óÂè£Â§ßÂ∞èÂèòÂåñÁõëÂê¨
        window.addEventListener('resize', () => {
            updateGameDimensions();
        });
        
        // Êô∫ËÉΩÈò≤ÊªöÂä®Êé™ÊñΩ - Âè™ÈòªÊ≠¢Ê∏∏ÊàèÁõ∏ÂÖ≥ÁöÑÊåâÈîÆÊªöÂä®
        function preventGameKeyScroll() {
            // Âè™ÈòªÊ≠¢Ê∏∏ÊàèÊéßÂà∂ÈîÆÂØºËá¥ÁöÑÈ°µÈù¢ÊªöÂä®
            const gameKeys = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
            
            document.addEventListener('keydown', (e) => {
                // Âè™ÊúâÂΩìÊåâ‰∏ãÊ∏∏ÊàèÊéßÂà∂ÈîÆÊó∂ÊâçÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
                if (gameKeys.includes(e.key) && !gameState.gameOver) {
                    e.preventDefault();
                    return false;
                }
            }, { passive: false });
            
            // ÈòªÊ≠¢ÂèåÊåáÁº©ÊîæÁ≠âÊâãÂäøÔºà‰øùÊåÅÊ∏∏Êàè‰ΩìÈ™åÔºâ
            document.addEventListener('gesturestart', (e) => {
                e.preventDefault();
            }, { passive: false });
            
            document.addEventListener('gesturechange', (e) => {
                e.preventDefault();
            }, { passive: false });
            
            document.addEventListener('gestureend', (e) => {
                e.preventDefault();
            }, { passive: false });
        }
        
        // ÂàùÂßãÂåñÊô∫ËÉΩÈò≤ÊªöÂä®ÂäüËÉΩ
        preventGameKeyScroll();
        
        // ÂàùÂßãÂåñÁßªÂä®Á´ØÊéßÂà∂
        initMobileControls();
        
        // ÊòæÁ§∫ÁßªÂä®Á´ØÊìç‰ΩúÊèêÁ§∫
        function showTouchHint() {
            const touchHint = document.getElementById('touch-hint');
            const isMobile = window.matchMedia('(hover: none) and (pointer: coarse)').matches;
            
            if (isMobile && touchHint) {
                touchHint.classList.add('show');
                setTimeout(() => {
                    touchHint.classList.remove('show');
                }, 4000); // 4ÁßíÂêéËá™Âä®ÈöêËóè
            }
        }
        
        // Âú®ÁßªÂä®ËÆæÂ§á‰∏äÊòæÁ§∫Êìç‰ΩúÊèêÁ§∫
        if (window.matchMedia('(hover: none) and (pointer: coarse)').matches) {
            setTimeout(showTouchHint, 1000); // 1ÁßíÂêéÊòæÁ§∫ÊèêÁ§∫
        }
        
        // ÂºÄÂßãÊ∏∏Êàè
        initGame();
        gameLoop();
    </script>
</body>
</html>